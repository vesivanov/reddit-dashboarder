<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reddit Three-Pane Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; }
    .post-body { font-size: 0.875rem; line-height: 1.6; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }
  </style>
</head>
<body class="bg-zinc-100 min-h-screen text-zinc-900">
  <div id="root"></div>
  <script>
    const { useCallback, useEffect, useMemo, useRef, useState } = React;
    const { createRoot } = ReactDOM;
    const h = React.createElement;

    const DEFAULT_API_URL = "/api/reddit";
    const DEFAULT_SUBS = [];
    const STARTER_PACKS = [
      {
        id: 'tech-news',
        label: 'Tech News',
        emoji: 'ðŸ’»',
        subs: ['technology', 'gadgets', 'futurology', 'programming'],
      },
      {
        id: 'design-inspo',
        label: 'Design',
        emoji: 'ðŸŽ¨',
        subs: ['design', 'web_design', 'graphic_design', 'productdesign'],
      },
      {
        id: 'data-ai',
        label: 'AI & Data',
        emoji: 'ðŸ¤–',
        subs: ['machinelearning', 'datascience', 'openai', 'artificial'],
      },
    ];
    const POPULAR_SUBREDDITS = [
      'askreddit', 'worldnews', 'news', 'technology', 'programming',
      'todayilearned', 'design', 'dataisbeautiful', 'futurology',
      'productdesign', 'webdev', 'javascript', 'python', 'rust',
    ];
    const UPVOTE_PRESETS = [
      { value: '', label: 'Any' },
      { value: '10', label: '10+' },
      { value: '50', label: '50+' },
      { value: '100', label: '100+' },
      { value: '500', label: '500+' },
    ];
    const COMMENT_PRESETS = [
      { value: '', label: 'Any' },
      { value: '5', label: '5+' },
      { value: '20', label: '20+' },
      { value: '50', label: '50+' },
    ];
    const AUTO_REFRESH_OPTIONS = [5, 10, 15, 30, 45, 60];
    const MIN_AUTO_REFRESH_MINUTES = 5;

    function App() {
      const [subs, setSubs] = useState(() => {
        try {
          let saved = localStorage.getItem('dashboard_subs');
          if (saved) return JSON.parse(saved);
          saved = localStorage.getItem('dashboard_subs_backup');
          if (saved) {
            const parsed = JSON.parse(saved);
            localStorage.setItem('dashboard_subs', saved);
            return parsed;
          }
        } catch (error) {
          console.warn('Unable to parse saved subs', error);
        }
        return DEFAULT_SUBS;
      });
      const [mode, setMode] = useState('new');
      const [time, setTime] = useState('day');
      const [days, setDays] = useState(1);
      const [limit, setLimit] = useState(100);
      const [maxPages, setMaxPages] = useState(() => {
        try {
          const saved = localStorage.getItem('dashboard_max_pages');
          if (saved) return Math.max(1, Math.min(500, Number(saved) || 5));
        } catch (error) {}
        return 100;
      });
      const [loading, setLoading] = useState(false);
      const [autoRefreshEnabled, setAutoRefreshEnabled] = useState(() => {
        try {
          return localStorage.getItem('dashboard_auto_refresh_enabled') === '1';
        } catch (error) { return false; }
      });
      const [autoRefreshInterval, setAutoRefreshInterval] = useState(() => {
        try {
          const saved = Number(localStorage.getItem('dashboard_auto_refresh_interval'));
          if (Number.isFinite(saved)) {
            return Math.min(60, Math.max(MIN_AUTO_REFRESH_MINUTES, Math.round(saved)));
          }
        } catch (error) {}
        return 10;
      });
      const [error, setError] = useState('');
      const [needsAuth, setNeedsAuth] = useState(false);
      const [data, setData] = useState([]);
      const [selectedSub, setSelectedSub] = useState('ALL');
      const [selectedPost, setSelectedPost] = useState(null);
      const [fetchedAt, setFetchedAt] = useState(null);
      const [keyword, setKeyword] = useState('');
      const [fetchMethod, setFetchMethod] = useState('server');
      const [authenticated, setAuthenticated] = useState(false);
      const [authChecking, setAuthChecking] = useState(true);
      const [settingsOpen, setSettingsOpen] = useState(false);
      const [addSubOpen, setAddSubOpen] = useState(false);
      const [addSubInput, setAddSubInput] = useState('');
      const [minUpvoteFilter, setMinUpvoteFilter] = useState('');
      const [minCommentFilter, setMinCommentFilter] = useState('');
      const [sortBy, setSortBy] = useState('date');
      const [sortOrder, setSortOrder] = useState('desc');
      const [nextRefreshAt, setNextRefreshAt] = useState(null);
      const [lastAutoRefreshAt, setLastAutoRefreshAt] = useState(null);
      const [detailCollapsed, setDetailCollapsed] = useState(false);
      const loadingRef = useRef(false);
      const addSubInputRef = useRef(null);

      useEffect(() => { loadingRef.current = loading; }, [loading]);

      // Persist subs
      useEffect(() => {
        try {
          const subsJson = JSON.stringify(subs);
          localStorage.setItem('dashboard_subs', subsJson);
          localStorage.setItem('dashboard_subs_backup', subsJson);
        } catch (e) { console.warn('Unable to persist subs', e); }
      }, [subs]);

      useEffect(() => {
        try { localStorage.setItem('dashboard_max_pages', String(maxPages)); } catch {}
      }, [maxPages]);

      useEffect(() => {
        try { localStorage.setItem('dashboard_auto_refresh_enabled', autoRefreshEnabled ? '1' : '0'); } catch {}
      }, [autoRefreshEnabled]);

      useEffect(() => {
        try { localStorage.setItem('dashboard_auto_refresh_interval', String(autoRefreshInterval)); } catch {}
      }, [autoRefreshInterval]);

      // Check auth on mount
      useEffect(() => {
        let cancelled = false;
        async function checkAuth() {
          setAuthChecking(true);
          try {
            const response = await fetch('/api/auth/status', { cache: 'no-store' });
            if (!response.ok) throw new Error('Failed to check auth status');
            const payload = await response.json();
            if (!cancelled) setAuthenticated(Boolean(payload.authenticated));
          } catch (e) {
            if (!cancelled) setAuthenticated(false);
          } finally {
            if (!cancelled) setAuthChecking(false);
          }
        }
        checkAuth();
        return () => { cancelled = true; };
      }, []);

      const allPosts = useMemo(() => {
        const rows = [];
        for (const group of data) {
          for (const post of group.posts || []) rows.push(post);
        }
        rows.sort((a, b) => (b.created_utc || 0) - (a.created_utc || 0));
        return rows;
      }, [data]);

      const filteredBySub = useMemo(() => {
        if (selectedSub === 'ALL') return allPosts;
        const selected = selectedSub.toLowerCase();
        return allPosts.filter(post => post.subreddit?.toLowerCase() === selected);
      }, [allPosts, selectedSub]);

      const visiblePosts = useMemo(() => {
        const q = keyword.trim().toLowerCase();
        const minScore = parseNumberFilter(minUpvoteFilter);
        const minCommentsValue = parseNumberFilter(minCommentFilter);

        const filtered = filteredBySub.filter(post => {
          if (q) {
            const title = post.title ? post.title.toLowerCase() : '';
            const selftext = post.selftext ? post.selftext.toLowerCase() : '';
            if (!title.includes(q) && !selftext.includes(q)) return false;
          }
          const score = Number(post.score) || 0;
          if (minScore !== null && score < minScore) return false;
          const comments = Number(post.num_comments) || 0;
          if (minCommentsValue !== null && comments < minCommentsValue) return false;
          return true;
        });

        const multiplier = sortOrder === 'asc' ? 1 : -1;
        return [...filtered].sort((a, b) => {
          let delta = 0;
          switch (sortBy) {
            case 'upvotes': delta = (Number(a.score) || 0) - (Number(b.score) || 0); break;
            case 'comments': delta = (Number(a.num_comments) || 0) - (Number(b.num_comments) || 0); break;
            default: delta = (Number(a.created_utc) || 0) - (Number(b.created_utc) || 0); break;
          }
          return delta === 0 ? 0 : delta * multiplier;
        });
      }, [filteredBySub, keyword, minUpvoteFilter, minCommentFilter, sortBy, sortOrder]);

      const { maxScore, maxComments } = useMemo(() => {
        let maxScore = 0, maxComments = 0;
        for (const post of allPosts) {
          const score = Number(post.score);
          const comments = Number(post.num_comments);
          if (Number.isFinite(score)) maxScore = Math.max(maxScore, score);
          if (Number.isFinite(comments)) maxComments = Math.max(maxComments, comments);
        }
        return { maxScore, maxComments };
      }, [allPosts]);

      const subMetaMap = useMemo(() => {
        const map = new Map();
        for (const group of data) map.set(group.subreddit, group.meta || null);
        return map;
      }, [data]);

      const subPartialMap = useMemo(() => {
        const map = new Map();
        for (const group of data) map.set(group.subreddit, Boolean(group.partial));
        return map;
      }, [data]);

      const refresh = useCallback(async (options = {}) => {
        const triggeredByAuto = Boolean(options.triggeredByAuto);
        if (!subs.length) {
          setNeedsAuth(false);
          setError('Add at least one subreddit to get started.');
          setData([]);
          setFetchedAt(null);
          setNextRefreshAt(null);
          return;
        }

        setLoading(true);
        setError('');
        setNeedsAuth(false);
        const controller = new AbortController();
        const timeoutMs = Math.min(45000, 5000 + subs.length * 3000);
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

        try {
          const params = new URLSearchParams({
            subs: subs.join(','),
            mode,
            time,
            days: String(days),
            limit: String(subs.length > 6 ? Math.min(50, limit) : limit)
          });
          if (mode === 'new') {
            const effMaxPages = subs.length > 6 ? Math.min(10, maxPages) : maxPages;
            params.set('max_pages', String(effMaxPages));
          }

          setFetchMethod('server');
          const response = await fetch(`${DEFAULT_API_URL}?${params.toString()}`, { cache: 'no-store', signal: controller.signal });

          if (response.status === 401) {
            setNeedsAuth(true);
            setAuthenticated(false);
            setAuthChecking(false);
            setError('Sign in with Reddit to fetch your dashboard.');
            setData([]);
            setFetchedAt(null);
            return;
          }

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const rateLimitedHeader = response.headers.get('X-Rate-Limited') === '1';
          const payload = await response.json();
          if (rateLimitedHeader || payload.rate_limited) {
            setError('Reddit is rate limiting. Try fewer subreddits or wait a minute.');
          }
          const results = Array.isArray(payload.results) ? payload.results : [];
          const perSub = subs.map(sub => {
            const match = results.find(r => (r.subreddit || '').toLowerCase() === sub.toLowerCase());
            if (match) return {
              subreddit: match.subreddit,
              meta: match.meta || null,
              posts: match.posts || [],
              partial: Boolean(match.partial),
              error: match.error || null,
            };
            return { subreddit: sub, posts: [], meta: null, partial: false, error: null };
          });
          setNeedsAuth(false);
          setAuthenticated(true);
          setAuthChecking(false);
          setData(perSub);
          setFetchedAt(Date.now());
        } catch (fetchError) {
          setNeedsAuth(false);
          if (fetchError?.name === 'AbortError') {
            setError(`Request timed out. Reddit may be slow. Try again.`);
          } else {
            setError(fetchError.message || 'Failed to fetch');
          }
          setData([]);
          setFetchedAt(null);
        } finally {
          clearTimeout(timeoutId);
          setLoading(false);
          if (autoRefreshEnabled && subs.length) {
            setNextRefreshAt(Date.now() + autoRefreshInterval * 60 * 1000);
          } else {
            setNextRefreshAt(null);
          }
          if (triggeredByAuto) setLastAutoRefreshAt(Date.now());
        }
      }, [subs, mode, time, days, limit, maxPages, autoRefreshEnabled, autoRefreshInterval]);

      const refreshRef = useRef(refresh);
      useEffect(() => { refreshRef.current = refresh; }, [refresh]);

      useEffect(() => {
        if (!autoRefreshEnabled) setLastAutoRefreshAt(null);
      }, [autoRefreshEnabled]);

      useEffect(() => {
        if (!autoRefreshEnabled || !subs.length) {
          setNextRefreshAt(null);
          return () => {};
        }
        const intervalMs = Math.max(MIN_AUTO_REFRESH_MINUTES, autoRefreshInterval) * 60 * 1000;
        setNextRefreshAt(Date.now() + intervalMs);
        let cancelled = false;
        const triggerRefresh = () => {
          if (cancelled || loadingRef.current || !subs.length) return;
          refreshRef.current({ triggeredByAuto: true });
        };
        const kickoff = setTimeout(triggerRefresh, 200);
        const intervalId = setInterval(triggerRefresh, intervalMs);
        return () => { cancelled = true; clearTimeout(kickoff); clearInterval(intervalId); };
      }, [autoRefreshEnabled, autoRefreshInterval, subs.length]);

      const handleAddSub = useCallback((name) => {
        const normalized = normalizeSubredditName(name);
        if (!normalized) return;
        setSubs(prev => {
          if (prev.some(s => s.toLowerCase() === normalized.toLowerCase())) return prev;
          return [...prev, normalized];
        });
      }, []);

      const handleRemoveSub = useCallback((name) => {
        setSubs(prev => prev.filter(s => s.toLowerCase() !== name.toLowerCase()));
        if (selectedSub.toLowerCase() === name.toLowerCase()) setSelectedSub('ALL');
      }, [selectedSub]);

      const handleAddSubSubmit = useCallback(() => {
        const names = addSubInput.split(/[,\n]+/).map(s => normalizeSubredditName(s)).filter(Boolean);
        if (names.length === 0) return;
        setSubs(prev => {
          const existing = new Set(prev.map(s => s.toLowerCase()));
          const newOnes = names.filter(n => !existing.has(n.toLowerCase()));
          return [...prev, ...newOnes];
        });
        setAddSubInput('');
        setAddSubOpen(false);
      }, [addSubInput]);

      const handleApplyStarterPack = useCallback((pack) => {
        if (!pack?.subs) return;
        setSubs(prev => {
          const existing = new Set(prev.map(s => s.toLowerCase()));
          const newOnes = pack.subs.filter(s => !existing.has(s.toLowerCase()));
          return [...prev, ...newOnes];
        });
      }, []);

      // Keyboard shortcut for search
      useEffect(() => {
        const handler = (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('search-input')?.focus();
          }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
      }, []);

      const filtersActive = minUpvoteFilter || minCommentFilter;

      return h('div', { className: 'h-screen flex flex-col' },
        // Header
        h('header', { className: 'bg-white border-b border-zinc-200 px-4 py-3 flex items-center justify-between gap-4 shrink-0' },
            h('div', { className: 'flex items-center gap-3' },
            h('h1', { className: 'text-lg font-bold text-zinc-900' }, 'Reddit Dashboarder'),
            ),
            h('div', { className: 'flex items-center gap-2' },
              h('button', {
                onClick: () => setSettingsOpen(true),
              className: 'p-2 rounded-lg hover:bg-zinc-100 text-zinc-600 transition-colors',
              title: 'Settings'
            }, h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' }),
                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' })
            )),
              authChecking
              ? h('div', { className: 'px-3 py-1.5 text-sm text-zinc-500' }, 'Checkingâ€¦')
                : authenticated
                  ? h('button', {
                      onClick: () => { window.location.href = '/api/auth/logout'; },
                    className: 'px-3 py-1.5 rounded-lg text-sm font-medium text-zinc-600 hover:bg-zinc-100 transition-colors'
                    }, 'Sign out')
                  : h('button', {
                      onClick: () => { window.location.href = '/api/auth/start'; },
                    className: 'px-3 py-1.5 rounded-lg text-sm font-medium bg-zinc-900 text-white hover:bg-zinc-800 transition-colors'
                    }, 'Sign in')
          )
        ),

        // Status bar
        h('div', { className: 'bg-zinc-50 border-b border-zinc-200 px-4 py-2 flex items-center justify-between gap-4 text-sm shrink-0' },
          h('div', { className: 'flex items-center gap-4' },
            loading
              ? h('span', { className: 'flex items-center gap-2 text-zinc-600' },
                  h('div', { className: 'w-3 h-3 border-2 border-zinc-300 border-t-zinc-600 rounded-full animate-spin' }),
                  'Fetchingâ€¦'
                )
              : error
                ? h('span', { className: 'text-rose-600 font-medium' }, error)
                : needsAuth
                  ? h('span', { className: 'text-amber-600 font-medium' }, 'Sign in required')
                  : h('span', { className: 'text-zinc-600' },
                      visiblePosts.length > 0
                        ? `${visiblePosts.length} posts`
                        : subs.length > 0 ? 'No posts found' : 'Add subreddits to start'
                    ),
            fetchedAt && !loading && h('span', { className: 'text-zinc-400' }, `Updated ${timeAgo(fetchedAt / 1000)}`),
            autoRefreshEnabled && nextRefreshAt && !loading && h('span', { className: 'text-zinc-400' }, `â€¢ Next ${formatTimeUntil(nextRefreshAt)}`)
          ),
          h('button', {
            onClick: () => refresh(),
            disabled: loading,
            className: 'flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-zinc-900 text-white text-sm font-medium hover:bg-zinc-800 disabled:opacity-50 transition-colors'
          },
            h('svg', { className: `w-4 h-4 ${loading ? 'animate-spin' : ''}`, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
              h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' })
            ),
            'Refresh'
          )
        ),

        // Main content area
        h('div', { className: 'flex-1 flex overflow-hidden' },
          // Left sidebar - Subreddits
          h('aside', { className: 'w-52 bg-white border-r border-zinc-200 flex flex-col shrink-0' },
            h('div', { className: 'p-3 border-b border-zinc-200 flex items-center justify-between' },
              h('span', { className: 'text-xs font-semibold uppercase tracking-wide text-zinc-500' }, 'Subreddits'),
                h('button', {
                onClick: () => { setAddSubOpen(true); setTimeout(() => addSubInputRef.current?.focus(), 50); },
                className: 'p-1 rounded hover:bg-zinc-100 text-zinc-500 hover:text-zinc-700 transition-colors',
                title: 'Add subreddit'
              }, h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
              ))
            ),
            h('div', { className: 'flex-1 overflow-auto scrollbar-thin p-2 space-y-1' },
              subs.length === 0
                ? h('div', { className: 'p-4 text-center' },
                    h('p', { className: 'text-sm text-zinc-500 mb-3' }, 'No subreddits yet'),
                    h('div', { className: 'space-y-2' },
                      STARTER_PACKS.map(pack =>
                        h('button', {
                          key: pack.id,
                          onClick: () => handleApplyStarterPack(pack),
                          className: 'w-full px-3 py-2 rounded-lg border border-zinc-200 hover:border-zinc-300 hover:bg-zinc-50 text-left text-sm transition-colors'
                        },
                          h('span', { className: 'mr-1.5' }, pack.emoji),
                          pack.label
                        )
                      )
                    ),
                    h('button', {
                      onClick: () => { setAddSubOpen(true); setTimeout(() => addSubInputRef.current?.focus(), 50); },
                      className: 'mt-3 text-xs text-indigo-600 hover:text-indigo-700 font-medium'
                    }, '+ Add custom')
                  )
                : [
                    h('button', {
                      key: 'all',
                      onClick: () => setSelectedSub('ALL'),
                      className: `w-full px-3 py-2 rounded-lg text-left text-sm font-medium transition-colors ${selectedSub === 'ALL' ? 'bg-indigo-50 text-indigo-700' : 'hover:bg-zinc-50 text-zinc-700'}`
                    },
                      h('div', { className: 'flex items-center justify-between' },
                        h('span', null, 'All'),
                        h('span', { className: 'text-xs text-zinc-400' }, allPosts.length)
                      )
                    ),
                    ...subs.map(sub => {
                      const postCount = allPosts.filter(p => p.subreddit?.toLowerCase() === sub.toLowerCase()).length;
                      const isSelected = selectedSub.toLowerCase() === sub.toLowerCase();
                    const meta = subMetaMap.get(sub) || {};
                      return h('div', {
                      key: sub,
                        className: `group rounded-lg transition-colors ${isSelected ? 'bg-indigo-50' : 'hover:bg-zinc-50'}`
                      },
                        h('button', {
                      onClick: () => setSelectedSub(sub),
                          className: `w-full px-3 py-2 text-left`
                    },
                      h('div', { className: 'flex items-center justify-between' },
                            h('span', { className: `text-sm font-medium ${isSelected ? 'text-indigo-700' : 'text-zinc-700'}` }, `r/${sub}`),
                        h('div', { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-xs text-zinc-400' }, postCount),
                          h('button', {
                                onClick: (e) => { e.stopPropagation(); handleRemoveSub(sub); },
                                className: 'opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-zinc-200 text-zinc-400 hover:text-zinc-600 transition-all',
                            title: 'Remove'
                              }, h('svg', { className: 'w-3 h-3', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                              h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
                              ))
                            )
                          ),
                          meta.subscribers && h('div', { className: 'text-[11px] text-zinc-400 mt-0.5' }, `${formatSubs(meta.subscribers)} members`)
                        )
                      );
                    })
                  ]
            )
          ),

          // Center - Post list
          h('main', { className: `flex-1 flex flex-col bg-zinc-50 min-w-0 ${detailCollapsed ? '' : 'lg:border-r lg:border-zinc-200'}` },
            // Filter toolbar
            h('div', { className: 'bg-white border-b border-zinc-200 px-4 py-2.5 flex items-center gap-3 shrink-0 flex-wrap' },
              h('div', { className: 'relative flex-1 min-w-[200px] max-w-md' },
                h('svg', { className: 'absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' })
                ),
                h('input', {
                  id: 'search-input',
                  type: 'text',
                  value: keyword,
                  onChange: (e) => setKeyword(e.target.value),
                  placeholder: 'Search postsâ€¦ (âŒ˜K)',
                  className: 'w-full pl-9 pr-3 py-1.5 rounded-lg border border-zinc-200 text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:border-transparent'
                })
              ),
              h('div', { className: 'flex items-center gap-1.5' },
                h('span', { className: 'text-xs text-zinc-500 mr-1' }, 'â–²'),
                UPVOTE_PRESETS.map(preset =>
                  h('button', {
                    key: `upvote-${preset.value}`,
                    onClick: () => setMinUpvoteFilter(minUpvoteFilter === preset.value ? '' : preset.value),
                    className: `px-2 py-1 rounded text-xs font-medium transition-colors ${minUpvoteFilter === preset.value ? 'bg-emerald-100 text-emerald-700' : 'bg-zinc-100 text-zinc-600 hover:bg-zinc-200'}`
                  }, preset.label)
                )
              ),
              h('div', { className: 'flex items-center gap-1.5' },
                h('span', { className: 'text-xs text-zinc-500 mr-1' }, 'ðŸ’¬'),
                COMMENT_PRESETS.map(preset =>
                  h('button', {
                    key: `comment-${preset.value}`,
                    onClick: () => setMinCommentFilter(minCommentFilter === preset.value ? '' : preset.value),
                    className: `px-2 py-1 rounded text-xs font-medium transition-colors ${minCommentFilter === preset.value ? 'bg-amber-100 text-amber-700' : 'bg-zinc-100 text-zinc-600 hover:bg-zinc-200'}`
                  }, preset.label)
                )
              ),
              h('select', {
                value: `${sortBy}-${sortOrder}`,
                onChange: (e) => {
                  const [by, order] = e.target.value.split('-');
                  setSortBy(by);
                  setSortOrder(order);
                },
                className: 'px-2 py-1 rounded-lg border border-zinc-200 text-xs bg-white'
              },
                h('option', { value: 'date-desc' }, 'Newest'),
                h('option', { value: 'date-asc' }, 'Oldest'),
                h('option', { value: 'upvotes-desc' }, 'Most upvotes'),
                h('option', { value: 'upvotes-asc' }, 'Least upvotes'),
                h('option', { value: 'comments-desc' }, 'Most comments'),
                h('option', { value: 'comments-asc' }, 'Least comments')
              ),
                filtersActive && h('button', {
                onClick: () => { setMinUpvoteFilter(''); setMinCommentFilter(''); },
                className: 'text-xs text-zinc-500 hover:text-zinc-700'
              }, 'Clear')
            ),

            // Post list
            h('div', { className: 'flex-1 overflow-auto scrollbar-thin' },
              visiblePosts.length === 0
                ? h('div', { className: 'flex items-center justify-center h-full text-zinc-500 text-sm' },
                    subs.length === 0 ? 'Add subreddits to get started' : loading ? 'Loadingâ€¦' : 'No posts match your filters'
                  )
                : h('div', { className: 'divide-y divide-zinc-200' },
                    visiblePosts.map(post => {
                        const isSelected = selectedPost?.id === post.id;
                        const score = Number(post.score) || 0;
                        const comments = Number(post.num_comments) || 0;
                        return h('button', {
                          key: post.id,
                        onClick: () => { setSelectedPost(post); setDetailCollapsed(false); },
                        className: `w-full text-left px-4 py-3 hover:bg-white transition-colors ${isSelected ? 'bg-white border-l-2 border-indigo-500' : 'bg-zinc-50'}`
                        },
                          h('div', { className: 'flex gap-3' },
                          post.thumbnail && post.thumbnail !== 'self' && post.thumbnail !== 'default' && post.thumbnail !== 'nsfw' && h('img', {
                              src: post.thumbnail,
                              alt: '',
                            className: 'w-16 h-16 object-cover rounded-lg shrink-0 bg-zinc-200'
                            }),
                            h('div', { className: 'flex-1 min-w-0' },
                            h('div', { className: 'flex items-center gap-2 text-xs text-zinc-500 mb-1' },
                              h('span', null, `r/${post.subreddit}`),
                              h('span', null, 'â€¢'),
                              h('span', null, timeAgo(post.created_utc))
                            ),
                            h('h3', { className: 'text-sm font-medium text-zinc-900 leading-snug line-clamp-2' }, post.title),
                            h('div', { className: 'flex items-center gap-3 mt-1.5 text-xs' },
                              h('span', { className: 'text-emerald-600 font-medium' }, `â–² ${score}`),
                              h('span', { className: 'text-amber-600 font-medium' }, `ðŸ’¬ ${comments}`),
                              h('span', { className: 'text-zinc-400' }, `u/${post.author}`)
                              )
                            )
                          )
                        );
                      })
                    )
            )
          ),

          // Right - Post detail
          !detailCollapsed && h('aside', { className: 'hidden lg:flex w-96 bg-white flex-col shrink-0' },
            h('div', { className: 'p-3 border-b border-zinc-200 flex items-center justify-between' },
              h('span', { className: 'text-xs font-semibold uppercase tracking-wide text-zinc-500' }, 'Post Detail'),
              h('button', {
                onClick: () => setDetailCollapsed(true),
                className: 'p-1 rounded hover:bg-zinc-100 text-zinc-400 hover:text-zinc-600',
                title: 'Collapse'
              }, h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13 5l7 7-7 7M5 5l7 7-7 7' })
              ))
            ),
            h('div', { className: 'flex-1 overflow-auto scrollbar-thin p-4' },
            !selectedPost
                ? h('div', { className: 'flex items-center justify-center h-full text-zinc-400 text-sm' }, 'Select a post to view')
                : h('article', { className: 'space-y-4' },
                    h('div', { className: 'flex items-center gap-2 text-xs text-zinc-500' },
                      h('span', { className: 'px-2 py-0.5 rounded bg-zinc-100 text-zinc-700 font-medium' }, `r/${selectedPost.subreddit}`),
                      h('span', null, timeAgo(selectedPost.created_utc))
                    ),
                    h('h2', { className: 'text-lg font-bold text-zinc-900 leading-snug' }, selectedPost.title),
                    h('div', { className: 'flex items-center gap-3 text-sm' },
                      h('span', { className: 'text-emerald-600 font-medium' }, `â–² ${selectedPost.score}`),
                      h('span', { className: 'text-amber-600 font-medium' }, `ðŸ’¬ ${selectedPost.num_comments}`),
                      h('span', { className: 'text-zinc-500' }, `u/${selectedPost.author}`)
                    ),
                    h('a', {
                      href: selectedPost.url,
                      target: '_blank',
                      rel: 'noreferrer',
                      className: 'inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-zinc-900 text-white text-sm font-medium hover:bg-zinc-800 transition-colors'
                    },
                      'Open on Reddit',
                      h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14' })
                      )
                    ),
                    h('div', { className: 'border-t border-zinc-200 pt-4' },
                      renderBody(selectedPost)
                  )
                )
          )
        ),

          // Collapsed detail toggle
          detailCollapsed && h('button', {
            onClick: () => setDetailCollapsed(false),
            className: 'hidden lg:flex items-center justify-center w-8 bg-white border-l border-zinc-200 text-zinc-400 hover:text-zinc-600 hover:bg-zinc-50 transition-colors',
            title: 'Expand detail panel'
          }, h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M11 19l-7-7 7-7m8 14l-7-7 7-7' })
          ))
        ),

        // Add subreddit modal
        addSubOpen && h('div', { className: 'fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4' },
          h('div', {
            className: 'w-full max-w-md bg-white rounded-xl shadow-xl',
            onClick: (e) => e.stopPropagation()
          },
            h('div', { className: 'p-4 border-b border-zinc-200 flex items-center justify-between' },
              h('h3', { className: 'font-semibold text-zinc-900' }, 'Add Subreddits'),
              h('button', {
                onClick: () => setAddSubOpen(false),
                className: 'p-1 rounded hover:bg-zinc-100 text-zinc-400 hover:text-zinc-600'
              }, h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
              ))
            ),
            h('div', { className: 'p-4 space-y-4' },
              h('div', null,
                h('label', { className: 'block text-sm font-medium text-zinc-700 mb-1.5' }, 'Subreddit names'),
                h('textarea', {
                  ref: addSubInputRef,
                  value: addSubInput,
                  onChange: (e) => setAddSubInput(e.target.value),
                  placeholder: 'programming, webdev, javascript...',
                  className: 'w-full px-3 py-2 border border-zinc-200 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500',
                  rows: 3
                }),
                h('p', { className: 'mt-1 text-xs text-zinc-500' }, 'Separate with commas or new lines')
              ),
              h('div', null,
                h('p', { className: 'text-xs font-medium text-zinc-500 uppercase tracking-wide mb-2' }, 'Popular'),
                h('div', { className: 'flex flex-wrap gap-1.5' },
                  POPULAR_SUBREDDITS.slice(0, 10).map(sub =>
                    h('button', {
                      key: sub,
                      onClick: () => { handleAddSub(sub); setAddSubOpen(false); },
                      disabled: subs.some(s => s.toLowerCase() === sub.toLowerCase()),
                      className: 'px-2.5 py-1 rounded-full text-xs font-medium bg-zinc-100 text-zinc-700 hover:bg-zinc-200 disabled:opacity-40 disabled:cursor-not-allowed transition-colors'
                    }, sub)
                  )
                )
              )
            ),
            h('div', { className: 'p-4 border-t border-zinc-200 flex justify-end gap-2' },
              h('button', {
                onClick: () => setAddSubOpen(false),
                className: 'px-4 py-2 rounded-lg text-sm font-medium text-zinc-600 hover:bg-zinc-100 transition-colors'
              }, 'Cancel'),
              h('button', {
                onClick: handleAddSubSubmit,
                disabled: !addSubInput.trim(),
                className: 'px-4 py-2 rounded-lg text-sm font-medium bg-zinc-900 text-white hover:bg-zinc-800 disabled:opacity-50 transition-colors'
              }, 'Add')
            )
          )
        ),

        // Settings modal
        settingsOpen && h('div', { className: 'fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4' },
          h('div', {
            className: 'w-full max-w-lg bg-white rounded-xl shadow-xl',
            onClick: (e) => e.stopPropagation()
          },
            h('div', { className: 'p-4 border-b border-zinc-200 flex items-center justify-between' },
              h('h3', { className: 'font-semibold text-zinc-900' }, 'Settings'),
                h('button', {
                onClick: () => setSettingsOpen(false),
                className: 'p-1 rounded hover:bg-zinc-100 text-zinc-400 hover:text-zinc-600'
              }, h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
              ))
            ),
            h('div', { className: 'p-4 space-y-5' },
              h('div', { className: 'flex items-center justify-between' },
                h('div', null,
                  h('p', { className: 'font-medium text-zinc-900' }, 'Auto-refresh'),
                  h('p', { className: 'text-sm text-zinc-500' }, 'Automatically fetch new posts')
                ),
                h('div', { className: 'flex items-center gap-3' },
                  h('select', {
                    value: autoRefreshInterval,
                    onChange: (e) => setAutoRefreshInterval(Number(e.target.value)),
                    disabled: !autoRefreshEnabled,
                    className: 'px-2 py-1.5 rounded-lg border border-zinc-200 text-sm disabled:opacity-50'
                  },
                    AUTO_REFRESH_OPTIONS.map(opt => h('option', { key: opt, value: opt }, `${opt} min`))
                  ),
                  h('button', {
                    onClick: () => setAutoRefreshEnabled(!autoRefreshEnabled),
                    className: `relative w-11 h-6 rounded-full transition-colors ${autoRefreshEnabled ? 'bg-indigo-600' : 'bg-zinc-300'}`
                  },
                    h('span', { className: `absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${autoRefreshEnabled ? 'translate-x-5' : ''}` })
                  )
                )
              ),
              h('div', { className: 'grid grid-cols-2 gap-4' },
                h('label', { className: 'block' },
                  h('span', { className: 'text-sm font-medium text-zinc-700' }, 'Listing mode'),
                    h('select', {
                      value: mode,
                    onChange: (e) => setMode(e.target.value),
                    className: 'mt-1 w-full px-3 py-2 rounded-lg border border-zinc-200 text-sm'
                    },
                      h('option', { value: 'new' }, 'New'),
                      h('option', { value: 'top' }, 'Top')
                    )
                  ),
                h('label', { className: 'block' },
                  h('span', { className: 'text-sm font-medium text-zinc-700' }, 'Top range'),
                    h('select', {
                      value: time,
                    onChange: (e) => setTime(e.target.value),
                      disabled: mode !== 'top',
                    className: 'mt-1 w-full px-3 py-2 rounded-lg border border-zinc-200 text-sm disabled:opacity-50'
                    },
                      h('option', { value: 'hour' }, 'Hour'),
                      h('option', { value: 'day' }, 'Day'),
                      h('option', { value: 'week' }, 'Week'),
                      h('option', { value: 'month' }, 'Month')
                    )
                  ),
                h('label', { className: 'block' },
                  h('span', { className: 'text-sm font-medium text-zinc-700' }, 'Lookback window'),
                    h('select', {
                      value: days,
                    onChange: (e) => setDays(Number(e.target.value)),
                    className: 'mt-1 w-full px-3 py-2 rounded-lg border border-zinc-200 text-sm'
                    },
                    h('option', { value: 1 }, 'Day'),
                      h('option', { value: 3 }, '3 Days'),
                    h('option', { value: 7 }, 'Week')
                    )
                  ),
                h('label', { className: 'block' },
                  h('span', { className: 'text-sm font-medium text-zinc-700' }, 'Max pages'),
                    h('select', {
                      value: maxPages,
                    onChange: (e) => setMaxPages(Number(e.target.value)),
                    className: 'mt-1 w-full px-3 py-2 rounded-lg border border-zinc-200 text-sm'
                    },
                      [5, 10, 20, 50, 100, 200].map(n => h('option', { key: n, value: n }, n))
                  )
                )
              ),
              h('div', { className: 'pt-4 border-t border-zinc-200' },
                h('p', { className: 'text-xs font-medium text-zinc-500 uppercase tracking-wide mb-3' }, 'Data Management'),
                h('div', { className: 'flex gap-2' },
                  h('button', {
                    onClick: () => {
                      const backup = JSON.stringify({ subs, maxPages, autoRefreshEnabled, autoRefreshInterval });
                      navigator.clipboard.writeText(backup);
                      alert('Settings copied to clipboard');
                    },
                    className: 'px-3 py-1.5 rounded-lg border border-zinc-200 text-sm font-medium text-zinc-700 hover:bg-zinc-50 transition-colors'
                  }, 'Export settings'),
                  h('button', {
                    onClick: () => {
                      const input = prompt('Paste your settings backup:');
                      if (input) {
                        try {
                          const parsed = JSON.parse(input);
                          if (parsed.subs) setSubs(parsed.subs);
                          if (parsed.maxPages) setMaxPages(parsed.maxPages);
                          if (typeof parsed.autoRefreshEnabled === 'boolean') setAutoRefreshEnabled(parsed.autoRefreshEnabled);
                          if (parsed.autoRefreshInterval) setAutoRefreshInterval(parsed.autoRefreshInterval);
                          alert('Settings restored');
                        } catch (e) {
                          alert('Invalid backup format');
                        }
                      }
                    },
                    className: 'px-3 py-1.5 rounded-lg border border-zinc-200 text-sm font-medium text-zinc-700 hover:bg-zinc-50 transition-colors'
                  }, 'Import settings')
                )
              )
            ),
            h('div', { className: 'p-4 border-t border-zinc-200 flex justify-end' },
                h('button', {
                onClick: () => setSettingsOpen(false),
                className: 'px-4 py-2 rounded-lg text-sm font-medium bg-zinc-900 text-white hover:bg-zinc-800 transition-colors'
              }, 'Done')
            )
          )
        )
      );
    }

    // Utility functions
    function formatTimeUntil(timestamp) {
      if (!timestamp) return '';
      const diff = Math.max(0, Number(timestamp) - Date.now());
      if (diff < 60 * 1000) return 'in <1 min';
      const minutes = Math.round(diff / 60000);
      if (minutes < 60) return `in ${minutes}m`;
      const hours = Math.floor(minutes / 60);
      return `in ${hours}h ${minutes % 60}m`;
    }

    function normalizeSubredditName(value) {
      if (typeof value !== 'string') return '';
      return value.trim().replace(/^r\//i, '').trim();
    }

    function timeAgo(utcSeconds) {
      const now = Date.now() / 1000;
      const diff = Math.max(1, Math.floor(now - (utcSeconds || 0)));
      const units = [
        [31536000, 'y'], [2592000, 'mo'], [604800, 'w'],
        [86400, 'd'], [3600, 'h'], [60, 'm'], [1, 's'],
      ];
      for (const [seconds, name] of units) {
        if (diff >= seconds) return `${Math.floor(diff / seconds)}${name}`;
      }
      return 'now';
    }

    function formatSubs(value) {
      if (!value && value !== 0) return '';
      if (value < 1000) return String(value);
      const units = ['k', 'M', 'B'];
      let unitIndex = -1;
      let val = value;
      while (val >= 1000 && unitIndex < units.length - 1) {
        val /= 1000;
        unitIndex += 1;
      }
      return `${val.toFixed(val >= 10 ? 0 : 1)}${units[unitIndex]}`;
    }

    function parseNumberFilter(value) {
      if (value === null || value === undefined || value === '') return null;
      const num = Number(value);
      return Number.isFinite(num) ? num : null;
    }

    function renderBody(post) {
      if (post.selftext_html) {
        const decoded = post.selftext_html
          .replace(/&lt;/g, '<').replace(/&gt;/g, '>')
          .replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
        return h('div', {
          className: 'post-body prose prose-sm prose-zinc max-w-none',
          dangerouslySetInnerHTML: { __html: decoded },
        });
      }
      if (post.selftext) {
        return h('div', { className: 'post-body whitespace-pre-wrap text-zinc-700 text-sm' }, post.selftext);
      }
      return h('div', { className: 'text-sm text-zinc-400 italic' }, 'Link post â€” no text content');
    }

    const root = createRoot(document.getElementById('root'));
    root.render(h(App));
  </script>
</body>
</html>
