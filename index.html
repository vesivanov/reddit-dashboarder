<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reddit Three-Pane Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; }
    .post-body {
      font-size: 0.875rem;
      line-height: 1.6;
    }
  </style>
</head>
<body class="bg-zinc-50 min-h-screen text-zinc-900">
  <div id="root"></div>
  <script>
    const { useEffect, useMemo, useState } = React;
    const { createRoot } = ReactDOM;
    const h = React.createElement;

    const DEFAULT_API_URL = "/api/reddit";
    const DEFAULT_SUBS = [];

    function App() {
      const [subs, setSubs] = useState(() => {
        try {
          // Try primary storage first
          let saved = localStorage.getItem('dashboard_subs');
          if (saved) return JSON.parse(saved);
          
          // Fallback to backup storage
          saved = localStorage.getItem('dashboard_subs_backup');
          if (saved) {
            const parsed = JSON.parse(saved);
            // Restore to primary storage
            localStorage.setItem('dashboard_subs', saved);
            return parsed;
          }
        } catch (error) {
          console.warn('Unable to parse saved subs', error);
        }
        return DEFAULT_SUBS;
      });
      const [subsInput, setSubsInput] = useState(() => {
        try {
          const saved = localStorage.getItem('dashboard_subs');
          if (saved) {
            const subs = JSON.parse(saved);
            return subs.join(', ');
          }
        } catch (error) {
          console.warn('Unable to parse saved subs', error);
        }
        return '';
      });
      const [mode, setMode] = useState('new');
      const [time, setTime] = useState('day');
      const [days, setDays] = useState(1);
      const [limit, setLimit] = useState(100);
      const [maxPages, setMaxPages] = useState(() => {
        try {
          const saved = localStorage.getItem('dashboard_max_pages');
          if (saved) return Math.max(1, Math.min(500, Number(saved) || 5));
        } catch (error) {}
        return 100;
      });
      const [loading, setLoading] = useState(false);
      const [error, setError] = useState('');
      const [needsAuth, setNeedsAuth] = useState(false);
      const [data, setData] = useState([]);
      const [selectedSub, setSelectedSub] = useState('ALL');
      const [selectedPost, setSelectedPost] = useState(null);
      const [fetchedAt, setFetchedAt] = useState(null);
      const [keyword, setKeyword] = useState('');
      const [fetchMethod, setFetchMethod] = useState('server'); // Track which method was used
      const [authenticated, setAuthenticated] = useState(false);
      const [authChecking, setAuthChecking] = useState(true);
      const [subsExpanded, setSubsExpanded] = useState(false);
      const [keywordExpanded, setKeywordExpanded] = useState(false);

      useEffect(() => {
        try {
          // Save to both primary and backup storage
          const subsJson = JSON.stringify(subs);
          localStorage.setItem('dashboard_subs', subsJson);
          localStorage.setItem('dashboard_subs_backup', subsJson);
          
          // Also save a timestamp for debugging
          localStorage.setItem('dashboard_subs_last_saved', new Date().toISOString());
        } catch (storageError) {
          console.warn('Unable to persist subs', storageError);
        }
      }, [subs]);

      useEffect(() => {
        // Sync subsInput when subs changes (e.g., from localStorage)
        setSubsInput(subs.join(', '));
      }, [subs]);

      useEffect(() => {
        try { localStorage.setItem('dashboard_max_pages', String(maxPages)); } catch {}
      }, [maxPages]);

      useEffect(() => {
        let cancelled = false;

        async function checkAuth() {
          setAuthChecking(true);
          try {
            const response = await fetch('/api/auth/status', { cache: 'no-store' });
            if (!response.ok) throw new Error('Failed to check auth status');
            const payload = await response.json();
            if (!cancelled) {
              setAuthenticated(Boolean(payload.authenticated));
            }
          } catch (statusError) {
            if (!cancelled) {
              setAuthenticated(false);
            }
          } finally {
            if (!cancelled) {
              setAuthChecking(false);
            }
          }
        }

        checkAuth();

        return () => {
          cancelled = true;
        };
      }, []);

      const allPosts = useMemo(() => {
        const rows = [];
        for (const group of data) {
          for (const post of group.posts || []) {
            rows.push(post);
          }
        }
        rows.sort((a, b) => (b.created_utc || 0) - (a.created_utc || 0));
        return rows;
      }, [data]);

      const filteredBySub = useMemo(() => {
        if (selectedSub === 'ALL') return allPosts;
        const selected = selectedSub.toLowerCase();
        return allPosts.filter(post => post.subreddit?.toLowerCase() === selected);
      }, [allPosts, selectedSub]);

      const visiblePosts = useMemo(() => {
        const q = keyword.trim().toLowerCase();
        if (!q) return filteredBySub;
        return filteredBySub.filter(post => {
          const title = post.title ? post.title.toLowerCase() : '';
          const selftext = post.selftext ? post.selftext.toLowerCase() : '';
          return title.includes(q) || selftext.includes(q);
        });
      }, [filteredBySub, keyword]);

      const { maxScore, maxComments } = useMemo(() => {
        let maxScore = 0;
        let maxComments = 0;
        for (const post of allPosts) {
          const score = Number(post.score);
          const comments = Number(post.num_comments);
          if (Number.isFinite(score)) {
            maxScore = Math.max(maxScore, score);
          }
          if (Number.isFinite(comments)) {
            maxComments = Math.max(maxComments, comments);
          }
        }
        return { maxScore, maxComments };
      }, [allPosts]);

      const subMetaMap = useMemo(() => {
        const map = new Map();
        for (const group of data) {
          map.set(group.subreddit, group.meta || null);
        }
        return map;
      }, [data]);
      const subPartialMap = useMemo(() => {
        const map = new Map();
        for (const group of data) {
          map.set(group.subreddit, Boolean(group.partial));
        }
        return map;
      }, [data]);

      async function refresh() {
        if (!subs.length) {
          setNeedsAuth(false);
          setError('Please add at least one subreddit.');
          setData([]);
          setFetchedAt(null);
          return;
        }

        setLoading(true);
        setError('');
        setNeedsAuth(false);
        setSelectedPost(null);
        const controller = new AbortController();
        const timeoutMs = Math.min(45000, 5000 + subs.length * 3000);
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

        try {
          const params = new URLSearchParams({
            subs: subs.join(','),
            mode,
            time,
            days: String(days),
            // If many subreddits are requested, cap per-page limit to reduce load
            limit: String(subs.length > 6 ? Math.min(50, limit) : limit)
          });
          if (mode === 'new') {
            // Lower max pages by default for many subs to avoid timeouts
            const effMaxPages = subs.length > 6 ? Math.min(10, maxPages) : maxPages;
            params.set('max_pages', String(effMaxPages));
          }

          // Use server API directly (client-side has CORS issues)
          setFetchMethod('server');
          const qs = new URLSearchParams(params);
          const response = await fetch(`${DEFAULT_API_URL}?${qs.toString()}`, { cache: 'no-store', signal: controller.signal });

          if (response.status === 401) {
            setNeedsAuth(true);
            setAuthenticated(false);
            setAuthChecking(false);
            setError('Sign in with Reddit to fetch your dashboard.');
            setData([]);
            setFetchedAt(null);
            return;
          }

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const rateLimitedHeader = response.headers.get('X-Rate-Limited') === '1';
          const payload = await response.json();
          if (rateLimitedHeader || payload.rate_limited) {
            setError('Reddit is rate limiting right now. Some subreddits returned no data. Try fewer subreddits, lower max pages, or wait a minute.');
          }
          const results = Array.isArray(payload.results) ? payload.results : [];
          const perSub = subs.map(sub => {
            const match = results.find(r => (r.subreddit || '').toLowerCase() === sub.toLowerCase());
            if (match) return {
              subreddit: match.subreddit,
              meta: match.meta || null,
              posts: match.posts || [],
              partial: Boolean(match.partial),
              error: match.error || null,
            };
            return { subreddit: sub, posts: [], meta: null, partial: false, error: null };
          });
          setNeedsAuth(false);
          setAuthenticated(true);
          setAuthChecking(false);
          setData(perSub);
          setFetchedAt(Date.now());
        } catch (fetchError) {
          setNeedsAuth(false);
          if (fetchError && fetchError.name === 'AbortError') {
            const seconds = Math.round(timeoutMs / 1000);
            setError(`Request timed out (${seconds}s). Reddit may be rate limiting. Try fewer subreddits or try again.`);
          } else if (fetchError && typeof fetchError.message === 'string' && fetchError.message.toLowerCase().includes('rate')) {
            setError('Reddit is rate limiting right now. Please wait a minute and try again.');
          } else {
            setError(fetchError.message || 'Failed to fetch');
          }
          setData([]);
          setFetchedAt(null);
        } finally {
          clearTimeout(timeoutId);
          setLoading(false);
        }
      }

      // Auto-refresh disabled by request: no background interval, no initial fetch
      // useEffect(() => {
      //   const id = setInterval(() => {
      //     refresh();
      //   }, 60 * 60 * 1000);
      //   return () => clearInterval(id);
      //   // eslint-disable-next-line react-hooks/exhaustive-deps
      // }, [subs, mode, time, days, limit, maxPages, workerUrl]);

      // useEffect(() => {
      //   refresh();
      //   // eslint-disable-next-line react-hooks/exhaustive-deps
      // }, []);

      return h('div', { className: 'max-w-7xl mx-auto p-4' },
        h('header', { className: 'flex flex-col md:flex-row md:items-end md:justify-between gap-3 mb-4' },
          h('div', null,
            h('h1', { className: 'text-2xl font-extrabold' }, 'Reddit Dashboarder'),
            h('p', { className: 'text-zinc-600 text-sm' }, 'Three-pane â€¢ Keyword filter â€¢ Day / 3 Days / Week â€¢ Full post body + subreddit stats')
          ),
          h('div', { className: 'flex flex-wrap items-center gap-2' },
            h('select', {
              className: 'border rounded-lg px-3 py-2',
              value: mode,
              onChange: event => setMode(event.target.value)
            },
              h('option', { value: 'new' }, 'new'),
              h('option', { value: 'top' }, 'top')
            ),
            h('select', {
              className: 'border rounded-lg px-3 py-2',
              value: time,
              onChange: event => setTime(event.target.value),
              disabled: mode !== 'top'
            },
              h('option', { value: 'hour' }, 'hour'),
              h('option', { value: 'day' }, 'day'),
              h('option', { value: 'week' }, 'week'),
              h('option', { value: 'month' }, 'month')
            ),
            h('select', {
              className: 'border rounded-lg px-3 py-2',
              value: days,
              onChange: event => setDays(Number(event.target.value) || 1)
            },
              h('option', { value: 1 }, 'Day'),
              h('option', { value: 3 }, '3 Days'),
              h('option', { value: 7 }, 'Week')
            ),
            h('select', {
              className: 'border rounded-lg px-3 py-2',
              value: maxPages,
              onChange: event => setMaxPages(Math.max(1, Math.min(500, Number(event.target.value) || 100)))
            },
              h('option', { value: 5 }, 'Max pages: 5'),
              h('option', { value: 10 }, 'Max pages: 10'),
              h('option', { value: 20 }, 'Max pages: 20'),
              h('option', { value: 50 }, 'Max pages: 50'),
              h('option', { value: 100 }, 'Max pages: 100'),
              h('option', { value: 200 }, 'Max pages: 200')
            ),
            h('button', {
              onClick: refresh,
              className: 'px-4 py-2 rounded-xl bg-black text-white font-semibold shadow disabled:opacity-50',
              disabled: loading
            }, loading ? 'Fetchingâ€¦' : 'Refresh'),
            authChecking
              ? h('div', {
                  className: 'px-3 py-2 rounded-xl border border-dashed border-zinc-300 bg-zinc-50 text-sm text-zinc-500 flex items-center gap-2'
                },
                  h('div', { className: 'w-3 h-3 border-2 border-zinc-300 border-t-zinc-600 rounded-full animate-spin' }),
                  'Checking authâ€¦'
                )
              : authenticated
                ? h('button', {
                    type: 'button',
                    className: 'px-3 py-2 rounded-xl border border-zinc-200 bg-white text-zinc-800 hover:bg-zinc-50 transition-colors font-semibold shadow-sm',
                    onClick: () => { window.location.href = '/api/auth/logout'; }
                  }, 'Sign out')
                : h('button', {
                    type: 'button',
                    className: 'px-3 py-2 rounded-xl border border-zinc-200 bg-white text-zinc-800 hover:bg-zinc-50 transition-colors font-semibold shadow-sm',
                    onClick: () => { window.location.href = '/api/auth/start'; }
                  }, 'Sign in')
          ),
        ),
        needsAuth ? h('div', { className: 'mb-3 rounded-2xl border border-amber-300 bg-amber-50 text-amber-900 px-4 py-3 space-y-1' },
          h('p', { className: 'font-semibold' }, 'Sign in required'),
          h('p', { className: 'text-sm' }, 'Sign in with Reddit to load personalized data for your dashboard.'),
        ) : null,
        h('div', { className: 'mb-3 space-y-2' },
          h('div', { className: 'bg-white rounded-2xl shadow p-3' },
            h('button', {
              className: 'w-full flex items-center justify-between text-left',
              onClick: () => setSubsExpanded(!subsExpanded)
            },
              h('div', { className: 'flex items-center gap-2' },
                h('span', { className: 'font-medium' }, 'Subreddits'),
                subs.length > 0 && h('span', { className: 'px-2 py-0.5 rounded-full bg-blue-100 text-blue-700 text-xs' }, `${subs.length} added`)
              ),
              h('span', { className: 'text-zinc-400' }, subsExpanded ? 'â–¼' : 'â–¶')
            ),
            subsExpanded && h('div', { className: 'mt-3 pt-3 border-t border-zinc-200' },
              h('textarea', {
                className: 'w-full border rounded-lg px-3 py-2 text-sm',
                rows: 3,
                value: subsInput,
                placeholder: 'Enter subreddit names separated by commas (e.g., programming, r/technology, webdev)',
                onChange: event => setSubsInput(event.target.value),
                onBlur: event => {
                  const list = event.target.value.split(',').map(item => {
                    const trimmed = item.trim();
                    return trimmed.startsWith('r/') ? trimmed.substring(2) : trimmed;
                  }).filter(Boolean);
                  setSubs(list);
                  try {
                    localStorage.setItem('dashboard_subs', JSON.stringify(list));
                    localStorage.setItem('dashboard_subs_backup', JSON.stringify(list));
                  } catch (e) {
                    console.warn('Failed to save subreddits:', e);
                  }
                }
              }),
              h('div', { className: 'flex flex-wrap gap-2 mt-2' },
                h('button', {
                  className: 'px-2 py-1 text-xs rounded-lg bg-blue-100 text-blue-700 hover:bg-blue-200',
                  onClick: () => {
                    const backup = JSON.stringify({ subs, maxPages });
                    navigator.clipboard.writeText(backup);
                    alert('Settings copied to clipboard!');
                  }
                }, 'ðŸ“‹ Export'),
                h('button', {
                  className: 'px-2 py-1 text-xs rounded-lg bg-green-100 text-green-700 hover:bg-green-200',
                  onClick: () => {
                    const input = prompt('Paste your settings backup:');
                    if (input) {
                      try {
                        const parsed = JSON.parse(input);
                        if (parsed.subs) setSubs(parsed.subs);
                        if (parsed.maxPages) setMaxPages(parsed.maxPages);
                        alert('Settings restored!');
                      } catch (e) {
                        alert('Invalid backup format');
                      }
                    }
                  }
                }, 'ðŸ“¥ Import')
              )
            )
          ),
          h('div', { className: 'bg-white rounded-2xl shadow p-3' },
            h('button', {
              className: 'w-full flex items-center justify-between text-left',
              onClick: () => setKeywordExpanded(!keywordExpanded)
            },
              h('div', { className: 'flex items-center gap-2' },
                h('span', { className: 'font-medium' }, 'Search'),
                keyword && h('span', { className: 'px-2 py-0.5 rounded-full bg-green-100 text-green-700 text-xs' }, `"${keyword}"`)
              ),
              h('span', { className: 'text-zinc-400' }, keywordExpanded ? 'â–¼' : 'â–¶')
            ),
            keywordExpanded && h('div', { className: 'mt-3 pt-3 border-t border-zinc-200' },
              h('input', {
                className: 'w-full border rounded-lg px-3 py-2 text-sm',
                value: keyword,
                onChange: event => setKeyword(event.target.value),
                placeholder: 'Type a keyword or phrase to search posts...'
              })
            )
          )
        ),
        h('div', { className: 'text-sm text-zinc-600 mb-2' },
          error
            ? h('span', { className: 'text-red-600' }, `Error: ${error}`)
            : h('span', null, 
                loading 
                  ? 'â³ Fetching from Reddit (this may take 30-60 seconds due to rate limits)...'
                  : `Fetched: ${fetchedAt ? formatDateTime(fetchedAt) : 'â€”'} â€¢ Posts: ${visiblePosts.length} â€¢ Mode: ${mode}${mode === 'top' ? ` (t=${time})` : ''} â€¢ Range: ${days} day(s) â€¢ Method: ${fetchMethod === 'client' ? 'ðŸŒ Client-side' : 'ðŸ–¥ï¸ Server'}`
              )
        ),
        h('div', { className: 'grid grid-cols-1 lg:grid-cols-12 gap-4' },
          h('aside', { className: 'lg:col-span-2 bg-white rounded-2xl shadow p-3 lg:p-2 lg:text-sm' },
            h('div', { className: 'flex items-center justify-between mb-3 lg:mb-2' },
              h('h2', { className: 'font-semibold text-base lg:text-sm' }, 'Subreddits'),
              h('button', {
                className: 'text-xs px-2 py-1 rounded-lg bg-zinc-100 hover:bg-zinc-200',
                onClick: () => setSelectedSub('ALL')
              }, 'All')
            ),
            subs.length === 0 
              ? h('div', { className: 'text-sm lg:text-xs text-zinc-500 italic text-center py-8 lg:py-6' },
                  h('div', { className: 'space-y-2' },
                    h('div', null, 'No subreddits added yet'),
                    h('div', { className: 'text-xs' }, 'Click "Subreddits" above to add some')
                  )
                )
              : h('div', { className: 'space-y-2 lg:space-y-1.5 max-h-[70vh] overflow-auto' },
                  subs.map(sub => {
                    const meta = subMetaMap.get(sub) || {};
                    const capped = subPartialMap.get(sub);
                    const postCount = allPosts.filter(post => post.subreddit?.toLowerCase() === sub.toLowerCase()).length;
                    return h('div', { key: sub, className: 'border border-zinc-200 rounded-lg p-3 lg:p-2 hover:border-zinc-300 transition-colors' },
                      h('button', {
                        onClick: () => setSelectedSub(sub),
                        className: `w-full text-left ${selectedSub === sub ? 'font-semibold' : ''}`
                      },
                        h('div', { className: 'flex items-center justify-between mb-2 lg:mb-1.5' },
                          h('span', { className: 'text-sm lg:text-xs font-medium' }, `r/${sub}`),
                          h('span', { className: 'text-xs text-zinc-500' }, `${postCount} posts`)
                        ),
                        h('div', { className: 'flex items-center gap-2 lg:gap-1.5 text-xs text-zinc-500' },
                          h('span', { className: 'leading-tight' }, `${formatSubs(meta.subscribers)} subscribers`),
                          meta.active_user_count && h('span', { className: 'leading-tight' }, `â€¢ ${formatSubs(meta.active_user_count)} active`),
                          capped && h('span', { className: 'px-1.5 py-0.5 rounded bg-orange-100 text-orange-700 border border-orange-200' }, 'capped')
                        )
                      )
                    );
                  })
                ),
            subs.length > 0 && h('p', { className: 'text-[11px] text-zinc-500 mt-3 pt-3 border-t border-zinc-200' }, 'Active â‰ˆ users online/active (15m window if provided by Reddit). Weekly contributors aren\'t available via public endpoints.')
          ),
          h('main', { className: 'lg:col-span-6 bg-white rounded-2xl shadow p-3 max-h-[80vh] overflow-auto' },
            h('h2', { className: 'font-semibold mb-3' }, selectedSub === 'ALL' ? 'Latest from all' : `Latest in r/${selectedSub}`),
            visiblePosts.length === 0 && h('div', { className: 'text-sm text-zinc-500' }, 
              subs.length === 0 
                ? 'Add some subreddits to get started!'
                : 'No posts. Try Refresh or adjust filters.'
            ),
            h('ul', { className: 'divide-y' },
              visiblePosts.map(post => {
                const rawScore = Number(post.score);
                const rawComments = Number(post.num_comments);
                const scoreValue = Number.isFinite(rawScore) ? Math.max(0, rawScore) : 0;
                const commentValue = Number.isFinite(rawComments) ? Math.max(0, rawComments) : 0;
                const scoreIntensity = scaleCountIntensity(scoreValue, maxScore);
                const commentIntensity = scaleCountIntensity(commentValue, maxComments);
                const accentIntensity = Math.max(scoreIntensity, commentIntensity);
                const scoreStyles = {
                  backgroundColor: tintWithWhite('#22c55e', scoreIntensity, { minMix: 0.15, maxMix: 0.85 }),
                  color: '#064e3b'
                };
                const commentStyles = {
                  backgroundColor: tintWithWhite('#f59e0b', commentIntensity, { minMix: 0.15, maxMix: 0.85 }),
                  color: '#713f12'
                };
                const cardStyles = {
                  backgroundColor: tintWithWhite('#e0e7ff', accentIntensity, { minMix: 0.3, maxMix: 0.96 })
                };

                return h('li', { key: post.id },
                  h('button', {
                    className: 'w-full text-left py-3 rounded-xl transition-colors hover:bg-zinc-50 focus:outline-none focus:ring-2 focus:ring-indigo-300',
                    onClick: () => setSelectedPost(post),
                    style: cardStyles
                  },
                    h('div', { className: 'flex gap-3 items-start px-2' },
                      post.thumbnail && h('img', {
                        src: post.thumbnail,
                        alt: '',
                        className: 'w-14 h-14 object-cover rounded-lg'
                      }),
                      h('div', { className: 'flex-1' },
                        h('div', { className: 'flex items-center gap-2 text-xs text-zinc-500' },
                          h('span', { className: 'tracking-wide uppercase' }, timeAgo(post.created_utc)),
                          h('span', { className: 'px-2 py-0.5 rounded bg-zinc-100 text-zinc-700' }, `r/${post.subreddit}`)
                        ),
                        h('div', { className: 'font-semibold leading-snug mt-1' }, post.title || ''),
                        h('div', { className: 'flex flex-wrap items-center gap-2 mt-1 text-sm' },
                          h('span', { className: 'px-2 py-0.5 rounded font-semibold', style: scoreStyles }, `â–² ${scoreValue} upvotes`),
                          h('span', { className: 'px-2 py-0.5 rounded font-semibold', style: commentStyles }, `ðŸ’¬ ${commentValue} comments`),
                          h('span', { className: 'text-zinc-600' }, `u/${post.author} â€¢ ${post.domain}`)
                        )
                      )
                    )
                  )
                );
              })
            )
          ),
          h('section', { className: 'lg:col-span-4 bg-white rounded-2xl shadow p-3 max-h-[80vh] overflow-auto' },
            h('h2', { className: 'font-semibold mb-2' }, 'Post'),
            !selectedPost
              ? h('div', { className: 'text-sm text-zinc-500' }, 'Select a post to preview.')
              : h('article', null,
                  h('div', { className: 'flex items-center gap-2 text-xs text-zinc-500' },
                    h('span', { className: 'tracking-wide uppercase' }, timeAgo(selectedPost.created_utc)),
                    h('span', { className: 'px-2 py-0.5 rounded bg-zinc-100 text-zinc-700' }, `r/${selectedPost.subreddit}`)
                  ),
                  h('h3', { className: 'text-lg font-bold mt-1 mb-2' }, selectedPost.title || ''),
                  h('div', { className: 'flex flex-wrap items-center gap-2 text-sm mb-3' },
                    h('span', {
                      className: 'px-2 py-0.5 rounded font-semibold',
                      style: {
                        backgroundColor: tintWithWhite('#22c55e', scaleCountIntensity(Number(selectedPost.score) || 0, maxScore), { minMix: 0.15, maxMix: 0.85 }),
                        color: '#064e3b'
                      }
                    }, `â–² ${selectedPost.score} upvotes`),
                    h('span', {
                      className: 'px-2 py-0.5 rounded font-semibold',
                      style: {
                        backgroundColor: tintWithWhite('#f59e0b', scaleCountIntensity(Number(selectedPost.num_comments) || 0, maxComments), { minMix: 0.15, maxMix: 0.85 }),
                        color: '#713f12'
                      }
                    }, 'ðŸ’¬ ' + String(selectedPost.num_comments) + ' comments'),
                    h('span', { className: 'text-zinc-600' }, `u/${selectedPost.author} â€¢ ${selectedPost.domain}`)
                  ),
                  renderBody(selectedPost),
                  h('a', {
                    href: selectedPost.url,
                    target: '_blank',
                    rel: 'noreferrer',
                    className: 'inline-block mt-4 px-4 py-2 rounded-xl bg-black text-white font-semibold shadow'
                  }, 'Open on Reddit')
                )
          )
        )
      );

    }

    function formatDateTime(timestamp) {
      const date = new Date(timestamp);
      if (Number.isNaN(date.getTime())) return '';
      return date.toLocaleString(undefined, {
        year: 'numeric',
        month: 'short',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });
    }

    function timeAgo(utcSeconds) {
      const now = Date.now() / 1000;
      const diff = Math.max(1, Math.floor(now - (utcSeconds || 0)));
      const units = [
        [31536000, 'year'],
        [2592000, 'month'],
        [604800, 'week'],
        [86400, 'day'],
        [3600, 'hour'],
        [60, 'minute'],
        [1, 'second'],
      ];
      for (const [seconds, name] of units) {
        if (diff >= seconds) {
          const count = Math.floor(diff / seconds);
          return `${count} ${name}${count > 1 ? 's' : ''} ago`;
        }
      }
      return 'just now';
    }

    function formatSubs(value) {
      if (!value && value !== 0) return '';
      if (value < 1000) return String(value);
      const units = ['k', 'M', 'B'];
      let unitIndex = -1;
      let val = value;
      while (val >= 1000 && unitIndex < units.length - 1) {
        val /= 1000;
        unitIndex += 1;
      }
      return `${val.toFixed(val >= 10 ? 0 : 1)}${units[unitIndex]}`;
    }

    function renderBody(post) {
      if (post.selftext_html) {
        const decoded = decodeHtml(post.selftext_html);
        return h('div', {
          className: 'post-body prose prose-zinc max-w-none',
          dangerouslySetInnerHTML: { __html: decoded },
        });
      }
      if (post.selftext) {
        return h('div', { className: 'post-body whitespace-pre-wrap text-zinc-800' }, post.selftext);
      }
      return h('div', { className: 'text-sm text-zinc-500' }, '(No text body â€” link post)');
    }

    function decodeHtml(str) {
      return str
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&amp;/g, '&')
        .replace(/&quot;/g, '"')
        .replace(/&#39;/g, "'");
    }

    function scaleCountIntensity(value, maxValue) {
      const rawValue = Number.isFinite(value) ? value : Number(value);
      const rawMax = Number.isFinite(maxValue) ? maxValue : Number(maxValue);
      const safeValue = Number.isFinite(rawValue) ? Math.max(0, rawValue) : 0;
      const safeMax = Number.isFinite(rawMax) ? Math.max(0, rawMax) : 0;
      if (safeValue <= 0) return 0;
      if (safeMax <= 0) return 1;
      const ratio = Math.log1p(safeValue) / Math.log1p(Math.max(1, safeMax));
      if (!Number.isFinite(ratio) || ratio <= 0) return 0;
      return Math.min(1, Math.max(0, ratio));
    }

    function tintWithWhite(hexColor, intensity, { minMix = 0.2, maxMix = 0.85 } = {}) {
      const { r, g, b } = hexToRgb(hexColor);
      const clampedIntensity = Math.min(1, Math.max(0, intensity || 0));
      const clampedMin = Math.min(1, Math.max(0, minMix));
      const clampedMax = Math.min(1, Math.max(0, maxMix));
      const mix = clampedMax - clampedIntensity * Math.max(0, clampedMax - clampedMin);
      const final = {
        r: Math.round(r + (255 - r) * mix),
        g: Math.round(g + (255 - g) * mix),
        b: Math.round(b + (255 - b) * mix),
      };
      return `rgb(${final.r}, ${final.g}, ${final.b})`;
    }

    function hexToRgb(hexColor) {
      if (typeof hexColor !== 'string') {
        return { r: 255, g: 255, b: 255 };
      }
      let hex = hexColor.replace('#', '').trim();
      if (hex.length === 3) {
        hex = hex.split('').map(char => char + char).join('');
      }
      if (hex.length !== 6) {
        return { r: 255, g: 255, b: 255 };
      }
      const value = parseInt(hex, 16);
      if (Number.isNaN(value)) {
        return { r: 255, g: 255, b: 255 };
      }
      return {
        r: (value >> 16) & 255,
        g: (value >> 8) & 255,
        b: value & 255,
      };
    }

    // Client-side Reddit API fetching removed due to CORS issues

    // Removed unused client-side functions

    const root = createRoot(document.getElementById('root'));
    root.render(h(App));
  </script>
</body>
</html>
