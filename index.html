<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Reddit Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
    }
  </script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/dompurify/3.0.6/purify.min.js"></script>
  <style>
    body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, Helvetica, Arial; }
    .post-body { font-size: 0.875rem; line-height: 1.6; }
    .scrollbar-thin::-webkit-scrollbar { width: 6px; }
    .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
    .scrollbar-thin::-webkit-scrollbar-thumb { background: #d4d4d8; border-radius: 3px; }
    .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #a1a1aa; }
    .dark .scrollbar-thin::-webkit-scrollbar-thumb { background: #52525b; }
    .dark .scrollbar-thin::-webkit-scrollbar-thumb:hover { background: #71717a; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(4px); } to { opacity: 1; transform: translateY(0); } }
    .animate-fadeIn { animation: fadeIn 0.15s ease-out; }
    
    /* Glassmorphism styles */
    .glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border: 1px solid rgba(255, 255, 255, 0.5);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    .dark .glass {
      background: rgba(24, 24, 27, 0.85);
      border: 1px solid rgba(63, 63, 70, 0.6);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    }
    
    /* Login overlay with blur */
    .login-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.3);
      backdrop-filter: blur(8px) saturate(1.2);
      -webkit-backdrop-filter: blur(8px) saturate(1.2);
      z-index: 50;
    }
    .dark .login-overlay {
      background: rgba(0, 0, 0, 0.5);
    }
    
    /* Preview dashboard blur */
    .dashboard-preview {
      filter: blur(2px) brightness(0.95);
      pointer-events: none;
      user-select: none;
    }
    .dark .dashboard-preview {
      filter: blur(2px) brightness(0.85);
    }
  </style>
</head>
<body class="bg-zinc-100 dark:bg-zinc-900 min-h-screen text-zinc-900 dark:text-zinc-100 transition-colors">
  <div id="root"></div>
  <script>
    const { useCallback, useEffect, useMemo, useRef, useState } = React;
    const { createRoot } = ReactDOM;
    const h = React.createElement;

    const DEFAULT_API_URL = "/api/reddit";
    const DEFAULT_SUBS = [];
    const STARTER_PACKS = [
      {
        id: 'tech-news',
        label: 'Tech News',
        emoji: 'ðŸ’»',
        subs: ['technology', 'gadgets', 'futurology', 'programming'],
      },
      {
        id: 'design-inspo',
        label: 'Design',
        emoji: 'ðŸŽ¨',
        subs: ['design', 'web_design', 'graphic_design', 'productdesign'],
      },
      {
        id: 'data-ai',
        label: 'AI & Data',
        emoji: 'ðŸ¤–',
        subs: ['machinelearning', 'datascience', 'openai', 'artificial'],
      },
    ];
    const POPULAR_SUBREDDITS = [
      'askreddit', 'worldnews', 'news', 'technology', 'programming',
      'todayilearned', 'design', 'dataisbeautiful', 'futurology',
      'productdesign', 'webdev', 'javascript', 'python', 'rust',
    ];
    const UPVOTE_PRESETS = [
      { value: '', label: 'Any' },
      { value: '10', label: '10+' },
      { value: '50', label: '50+' },
      { value: '100', label: '100+' },
      { value: '500', label: '500+' },
    ];
    const COMMENT_PRESETS = [
      { value: '', label: 'Any' },
      { value: '5', label: '5+' },
      { value: '20', label: '20+' },
      { value: '50', label: '50+' },
    ];
    const AI_RELEVANCE_PRESETS = [
      { value: '', label: 'Any' },
      { value: '5', label: '5+' },
      { value: '7', label: '7+' },
      { value: '8', label: '8+' },
    ];
    const AUTO_REFRESH_OPTIONS = [5, 10, 15, 30, 45, 60];
    const MIN_AUTO_REFRESH_MINUTES = 5;

    function App() {
      const [subs, setSubs] = useState(() => {
        try {
          let saved = localStorage.getItem('dashboard_subs');
          if (saved) return JSON.parse(saved);
          saved = localStorage.getItem('dashboard_subs_backup');
          if (saved) {
            const parsed = JSON.parse(saved);
            localStorage.setItem('dashboard_subs', saved);
            return parsed;
          }
        } catch (error) {
          console.warn('Unable to parse saved subs', error);
        }
        return DEFAULT_SUBS;
      });
      const [mode, setMode] = useState('new');
      const [time, setTime] = useState('day');
      const [days, setDays] = useState(1);
      const [limit, setLimit] = useState(100);
      const [maxPages, setMaxPages] = useState(() => {
        try {
          const saved = localStorage.getItem('dashboard_max_pages');
          if (saved) return Math.max(1, Math.min(10, Number(saved) || 5));
        } catch (error) {}
        return 5;
      });
      const [loading, setLoading] = useState(false);
      const [autoRefreshEnabled, setAutoRefreshEnabled] = useState(() => {
        try {
          return localStorage.getItem('dashboard_auto_refresh_enabled') === '1';
        } catch (error) { return false; }
      });
      const [autoRefreshInterval, setAutoRefreshInterval] = useState(() => {
        try {
          const saved = Number(localStorage.getItem('dashboard_auto_refresh_interval'));
          if (Number.isFinite(saved)) {
            return Math.min(60, Math.max(MIN_AUTO_REFRESH_MINUTES, Math.round(saved)));
          }
        } catch (error) {}
        return 10;
      });
      const [error, setError] = useState('');
      const [needsAuth, setNeedsAuth] = useState(false);
      const [data, setData] = useState(() => {
        try {
          const saved = localStorage.getItem('dashboard_data');
          if (saved) {
            const parsed = JSON.parse(saved);
            // Validate structure
            if (Array.isArray(parsed) && parsed.every(item => item.subreddit && Array.isArray(item.posts))) {
              return parsed;
            }
          }
        } catch (error) {
          console.warn('Unable to restore saved data', error);
        }
        return [];
      });
      const [selectedSub, setSelectedSub] = useState('ALL');
      const [selectedPost, setSelectedPost] = useState(null);
      const [fetchedAt, setFetchedAt] = useState(() => {
        try {
          const saved = localStorage.getItem('dashboard_fetched_at');
          if (saved) {
            const timestamp = Number(saved);
            if (timestamp > 0) return timestamp;
          }
        } catch (error) {}
        return null;
      });
      const [keyword, setKeyword] = useState('');
      const [fetchMethod, setFetchMethod] = useState('server');
      const [authenticated, setAuthenticated] = useState(false);
      const [authChecking, setAuthChecking] = useState(true);
      const [settingsOpen, setSettingsOpen] = useState(false);
      const [addSubOpen, setAddSubOpen] = useState(false);
      const [addSubInput, setAddSubInput] = useState('');
      const [minUpvoteFilter, setMinUpvoteFilter] = useState('');
      const [minCommentFilter, setMinCommentFilter] = useState('');
      const [minAiRelevance, setMinAiRelevance] = useState('');
      const [sortBy, setSortBy] = useState('date');
      const [sortOrder, setSortOrder] = useState('desc');
      const [nextRefreshAt, setNextRefreshAt] = useState(null);
      const [lastAutoRefreshAt, setLastAutoRefreshAt] = useState(null);
      const [detailCollapsed, setDetailCollapsed] = useState(false);
      const [darkMode, setDarkMode] = useState(() => {
        try {
          const saved = localStorage.getItem('dashboard_dark_mode');
          if (saved !== null) return saved === '1';
          return window.matchMedia('(prefers-color-scheme: dark)').matches;
        } catch { return false; }
      });
      const [hiddenPosts, setHiddenPosts] = useState(() => {
        try {
          const saved = localStorage.getItem('dashboard_hidden_posts');
          if (saved) {
            const arr = JSON.parse(saved);
            return new Set(Array.isArray(arr) ? arr : []);
          }
        } catch {}
        return new Set();
      });
      const [activePostMenu, setActivePostMenu] = useState(null);
      const [hoverPost, setHoverPost] = useState(null);
      const hoverTimeoutRef = useRef(null);
      const [notificationsEnabled, setNotificationsEnabled] = useState(() => {
        try { return localStorage.getItem('dashboard_notifications') === '1'; } catch { return false; }
      });
      const [upvoteThreshold, setUpvoteThreshold] = useState(() => {
        try { return Number(localStorage.getItem('dashboard_upvote_threshold')) || 100; } catch { return 100; }
      });
      const [alertKeywords, setAlertKeywords] = useState(() => {
        try { return localStorage.getItem('dashboard_alert_keywords') || ''; } catch { return ''; }
      });
      const [previousPostScores, setPreviousPostScores] = useState(new Map());
      const [mobileView, setMobileView] = useState('posts');
      const [touchStart, setTouchStart] = useState(null);
      const [aiGoals, setAiGoals] = useState(() => {
        try { return localStorage.getItem('dashboard_ai_goals') || ''; } catch { return ''; }
      });
      const [aiEnabled, setAiEnabled] = useState(() => {
        try {
          const saved = localStorage.getItem('dashboard_ai_enabled');
          return saved !== null ? saved === '1' : Boolean(localStorage.getItem('dashboard_ai_goals'));
        } catch { return false; }
      });
      const [openRouterApiKey, setOpenRouterApiKey] = useState(() => {
        try { return localStorage.getItem('dashboard_openrouter_api_key') || ''; } catch { return ''; }
      });
      const [secureKeyStatus, setSecureKeyStatus] = useState({ hasKey: false, keyPreview: null, checking: true });
      const [savingSecureKey, setSavingSecureKey] = useState(false);
      const [openRouterModel, setOpenRouterModel] = useState(() => {
        try { return localStorage.getItem('dashboard_openrouter_model') || 'qwen/qwen3-next-80b-a3b-instruct:free'; } catch { return 'qwen/qwen3-next-80b-a3b-instruct:free'; }
      });
      const [postRelevanceScores, setPostRelevanceScores] = useState(new Map());
      const [postRelevanceMetadata, setPostRelevanceMetadata] = useState(new Map());
      const [scoresVersion, setScoresVersion] = useState(0); // Version counter to force useMemo recalculation
      const [aiRankingLoading, setAiRankingLoading] = useState(false);
      const loadingRef = useRef(false);
      const addSubInputRef = useRef(null);

      useEffect(() => { loadingRef.current = loading; }, [loading]);

      // Persist subs
      useEffect(() => {
        try {
          const subsJson = JSON.stringify(subs);
          localStorage.setItem('dashboard_subs', subsJson);
          localStorage.setItem('dashboard_subs_backup', subsJson);
        } catch (e) { console.warn('Unable to persist subs', e); }
      }, [subs]);

      useEffect(() => {
        try { localStorage.setItem('dashboard_max_pages', String(maxPages)); } catch {}
      }, [maxPages]);

      useEffect(() => {
        try { localStorage.setItem('dashboard_auto_refresh_enabled', autoRefreshEnabled ? '1' : '0'); } catch {}
      }, [autoRefreshEnabled]);

      useEffect(() => {
        try { localStorage.setItem('dashboard_auto_refresh_interval', String(autoRefreshInterval)); } catch {}
      }, [autoRefreshInterval]);

      // Dark mode persistence and class toggle
      useEffect(() => {
        try { localStorage.setItem('dashboard_dark_mode', darkMode ? '1' : '0'); } catch {}
        if (darkMode) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
      }, [darkMode]);

      // Hidden posts persistence (limit to 1000 entries)
      useEffect(() => {
        try {
          const MAX_HIDDEN_POSTS = 1000;
          let arr = Array.from(hiddenPosts);
          if (arr.length > MAX_HIDDEN_POSTS) {
            arr = arr.slice(-MAX_HIDDEN_POSTS);
          }
          localStorage.setItem('dashboard_hidden_posts', JSON.stringify(arr));
        } catch {}
      }, [hiddenPosts]);

      // Notification settings persistence
      useEffect(() => {
        try { localStorage.setItem('dashboard_notifications', notificationsEnabled ? '1' : '0'); } catch {}
      }, [notificationsEnabled]);
      useEffect(() => {
        try { localStorage.setItem('dashboard_upvote_threshold', String(upvoteThreshold)); } catch {}
      }, [upvoteThreshold]);
      useEffect(() => {
        try { localStorage.setItem('dashboard_alert_keywords', alertKeywords); } catch {}
      }, [alertKeywords]);

      // AI settings persistence
      useEffect(() => {
        try { localStorage.setItem('dashboard_ai_goals', aiGoals); } catch {}
      }, [aiGoals]);
      useEffect(() => {
        try { localStorage.setItem('dashboard_ai_enabled', aiEnabled ? '1' : '0'); } catch {}
      }, [aiEnabled]);
      useEffect(() => {
        try { localStorage.setItem('dashboard_openrouter_api_key', openRouterApiKey); } catch {}
      }, [openRouterApiKey]);
      useEffect(() => {
        try { localStorage.setItem('dashboard_openrouter_model', openRouterModel); } catch {}
      }, [openRouterModel]);

      // Persist fetched data and timestamp
      useEffect(() => {
        try {
          if (data && data.length > 0) {
            localStorage.setItem('dashboard_data', JSON.stringify(data));
          }
        } catch (e) {
          console.warn('Unable to persist data', e);
        }
      }, [data]);

      useEffect(() => {
        try {
          if (fetchedAt) {
            localStorage.setItem('dashboard_fetched_at', String(fetchedAt));
          }
        } catch {}
      }, [fetchedAt]);

      // Restore and apply AI scores on initial load with restored data
      const hasRestoredScoresRef = useRef(false);
      useEffect(() => {
        // Only run once when data is available, AI is enabled, and we haven't restored scores yet
        if (data.length > 0 && aiEnabled && aiGoals && aiGoals.trim() && postRelevanceScores.size === 0 && !hasRestoredScoresRef.current) {
          hasRestoredScoresRef.current = true;
          console.log('Restoring AI scores from cache on page load...');
          
          // Load cached scores
          try {
            const cacheStr = localStorage.getItem('dashboard_ai_scores_cache');
            if (cacheStr) {
              const cache = JSON.parse(cacheStr);
              const now = Date.now();
              const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 hours
              const rawScores = new Map();
              const metadata = new Map();
              
              // Get all post IDs from current data
              const allPosts = data.flatMap(group => group.posts || []);
              
              // Load cached scores for posts that exist in cache
              allPosts.forEach(post => {
                const postId = post.id || post.data?.id;
                if (postId && cache[postId]) {
                  const cachedData = cache[postId];
                  if (cachedData.timestamp && (now - cachedData.timestamp) < CACHE_EXPIRY && cachedData.score > 0) {
                    rawScores.set(postId, cachedData.score);
                    metadata.set(postId, {
                      confidence: cachedData.confidence || 'medium',
                      reason: cachedData.reason || '',
                      source: 'cache-restored'
                    });
                  }
                }
              });
              
              if (rawScores.size > 0) {
                // Calibrate scores based on current feed
                const calibratedScores = calibrateScores(rawScores);
                const highRelevanceCount = Array.from(calibratedScores.values()).filter(s => s !== null && s !== undefined && s >= 7).length;
                console.log(`Restored and calibrated ${calibratedScores.size} AI scores from cache (${highRelevanceCount} posts scored >= 7)`);
                setPostRelevanceScores(calibratedScores);
                setPostRelevanceMetadata(metadata);
                setScoresVersion(v => v + 1);
              }
            }
          } catch (error) {
            console.warn('Failed to restore AI scores on load:', error);
          }
        }
      }, [data, aiEnabled, aiGoals, postRelevanceScores.size]); // Run when data or AI settings change

      // Touch/swipe gesture handlers
      const handleTouchStart = useCallback((e) => {
        setTouchStart({ x: e.touches[0].clientX, y: e.touches[0].clientY });
      }, []);
      const handleTouchEnd = useCallback((e) => {
        if (!touchStart) return;
        const deltaX = e.changedTouches[0].clientX - touchStart.x;
        const deltaY = e.changedTouches[0].clientY - touchStart.y;
        if (Math.abs(deltaX) > Math.abs(deltaY) && Math.abs(deltaX) > 50) {
          if (deltaX < 0) {
            // Swipe left
            if (mobileView === 'subs') setMobileView('posts');
            else if (mobileView === 'posts') setMobileView('detail');
          } else {
            // Swipe right
            if (mobileView === 'detail') setMobileView('posts');
            else if (mobileView === 'posts') setMobileView('subs');
          }
        }
        setTouchStart(null);
      }, [touchStart, mobileView]);

      // Request notification permission
      const requestNotificationPermission = useCallback(async () => {
        if (!('Notification' in window)) {
          alert('This browser does not support notifications');
          return;
        }
        const permission = await Notification.requestPermission();
        if (permission === 'granted') {
          setNotificationsEnabled(true);
        }
      }, []);

      // Send notification
      const sendNotification = useCallback((title, body) => {
        if (notificationsEnabled && Notification.permission === 'granted') {
          new Notification(title, { body, icon: '/favicon.ico' });
        }
      }, [notificationsEnabled]);

      // Check auth on mount
      useEffect(() => {
        let cancelled = false;
        async function checkAuth() {
          setAuthChecking(true);
          try {
            const response = await fetch('/api/auth/status', { cache: 'no-store' });
            if (!response.ok) throw new Error('Failed to check auth status');
            const payload = await response.json();
            if (!cancelled) setAuthenticated(Boolean(payload.authenticated));
          } catch (e) {
            if (!cancelled) setAuthenticated(false);
          } finally {
            if (!cancelled) setAuthChecking(false);
          }
        }
        checkAuth();
        return () => { cancelled = true; };
      }, []);

      // Check secure API key status on mount
      useEffect(() => {
        let cancelled = false;
        async function checkSecureKey() {
          try {
            const response = await fetch('/api/settings/openrouter-key', {
              credentials: 'include',
              cache: 'no-store'
            });
            if (response.ok) {
              const data = await response.json();
              if (!cancelled) {
                setSecureKeyStatus({ hasKey: data.hasKey, keyPreview: data.keyPreview, checking: false });
              }
            } else {
              if (!cancelled) setSecureKeyStatus({ hasKey: false, keyPreview: null, checking: false });
            }
          } catch (e) {
            console.warn('Failed to check secure API key status:', e);
            if (!cancelled) setSecureKeyStatus({ hasKey: false, keyPreview: null, checking: false });
          }
        }
        checkSecureKey();
        return () => { cancelled = true; };
      }, []); // Only run on mount - no dependencies needed

      const allPosts = useMemo(() => {
        const rows = [];
        for (const group of data) {
          for (const post of group.posts || []) rows.push(post);
        }
        rows.sort((a, b) => (b.created_utc || 0) - (a.created_utc || 0));
        return rows;
      }, [data]);

      const filteredBySub = useMemo(() => {
        if (selectedSub === 'ALL') return allPosts;
        const selected = selectedSub.toLowerCase();
        return allPosts.filter(post => post.subreddit?.toLowerCase() === selected);
      }, [allPosts, selectedSub]);

      const visiblePosts = useMemo(() => {
        const q = keyword.trim().toLowerCase();
        const minScore = parseNumberFilter(minUpvoteFilter);
        const minCommentsValue = parseNumberFilter(minCommentFilter);
        const minAiScore = parseNumberFilter(minAiRelevance);

        const filtered = filteredBySub.filter(post => {
          if (hiddenPosts.has(post.id)) return false;
          if (q) {
            const title = post.title ? post.title.toLowerCase() : '';
            const selftext = post.selftext ? post.selftext.toLowerCase() : '';
            if (!title.includes(q) && !selftext.includes(q)) return false;
          }
          const score = Number(post.score) || 0;
          if (minScore !== null && score < minScore) return false;
          const comments = Number(post.num_comments) || 0;
          if (minCommentsValue !== null && comments < minCommentsValue) return false;
          // AI relevance filter
          if (minAiScore !== null) {
            const aiScore = postRelevanceScores.get(String(post.id));
            if (aiScore === null || aiScore === undefined || aiScore < minAiScore) return false;
          }
          return true;
        });

        const multiplier = sortOrder === 'asc' ? 1 : -1;
        const sorted = [...filtered].sort((a, b) => {
          let delta = 0;
          switch (sortBy) {
            case 'upvotes': delta = (Number(a.score) || 0) - (Number(b.score) || 0); break;
            case 'comments': delta = (Number(a.num_comments) || 0) - (Number(b.num_comments) || 0); break;
            case 'ai-relevance': {
              const scoreA = postRelevanceScores.get(String(a.id));
              const scoreB = postRelevanceScores.get(String(b.id));
              // Posts without scores (undefined or null) go to the end
              const hasScoreA = scoreA !== undefined && scoreA !== null;
              const hasScoreB = scoreB !== undefined && scoreB !== null;
              if (!hasScoreA && !hasScoreB) {
                delta = 0; // Both have no score, maintain order
              } else if (!hasScoreA) {
                delta = 1; // a has no score, should go after b
              } else if (!hasScoreB) {
                delta = -1; // b has no score, should go after a
              } else {
                delta = scoreA - scoreB; // Both have scores, compare normally
              }
              break;
            }
            default: delta = (Number(a.created_utc) || 0) - (Number(b.created_utc) || 0); break;
          }
          return delta === 0 ? 0 : delta * multiplier;
        });
        
        // Debug logging for AI relevance sorting
        if (sortBy === 'ai-relevance') {
          const scoresCount = postRelevanceScores.size;
          const postsWithScores = sorted.filter(p => postRelevanceScores.has(String(p.id))).length;
          console.log(`AI Relevance Sort (${sortOrder}):`, {
            sortBy,
            sortOrder,
            totalPosts: sorted.length,
            postsWithScores,
            scoresInMap: scoresCount,
            firstFew: sorted.slice(0, 5).map(p => ({
              id: p.id,
              title: p.title?.substring(0, 40),
              score: postRelevanceScores.get(String(p.id))
            }))
          });
        }
        
        return sorted;
      }, [filteredBySub, keyword, minUpvoteFilter, minCommentFilter, minAiRelevance, sortBy, sortOrder, hiddenPosts, postRelevanceScores, scoresVersion]);

      const { maxScore, maxComments } = useMemo(() => {
        let maxScore = 0, maxComments = 0;
        for (const post of allPosts) {
          const score = Number(post.score);
          const comments = Number(post.num_comments);
          if (Number.isFinite(score)) maxScore = Math.max(maxScore, score);
          if (Number.isFinite(comments)) maxComments = Math.max(maxComments, comments);
        }
        return { maxScore, maxComments };
      }, [allPosts]);

      const subMetaMap = useMemo(() => {
        const map = new Map();
        for (const group of data) map.set(group.subreddit, group.meta || null);
        return map;
      }, [data]);

      const subPartialMap = useMemo(() => {
        const map = new Map();
        for (const group of data) map.set(group.subreddit, Boolean(group.partial));
        return map;
      }, [data]);

      const refresh = useCallback(async (options = {}) => {
        const triggeredByAuto = Boolean(options.triggeredByAuto);
        if (!subs.length) {
          setNeedsAuth(false);
          setError('Add at least one subreddit to get started.');
          setData([]);
          setFetchedAt(null);
          setNextRefreshAt(null);
          return;
        }

        setLoading(true);
        setError('');
        setNeedsAuth(false);
        const controller = new AbortController();
        const timeoutMs = Math.min(45000, 5000 + subs.length * 3000);
        const timeoutId = setTimeout(() => controller.abort(), timeoutMs);

        try {
          const params = new URLSearchParams({
            subs: subs.join(','),
            mode,
            time,
            days: String(days),
            limit: String(subs.length > 6 ? Math.min(50, limit) : limit)
          });
          if (mode === 'new') {
            const effMaxPages = subs.length > 6 ? Math.min(10, maxPages) : maxPages;
            params.set('max_pages', String(effMaxPages));
          }

          setFetchMethod('server');
          const response = await fetch(`${DEFAULT_API_URL}?${params.toString()}`, { cache: 'no-store', signal: controller.signal });

          if (response.status === 401) {
            setNeedsAuth(true);
            setAuthenticated(false);
            setAuthChecking(false);
            setError('Sign in with Reddit to fetch your dashboard.');
            setData([]);
            setFetchedAt(null);
            return;
          }

          if (!response.ok) throw new Error(`HTTP ${response.status}`);

          const rateLimitedHeader = response.headers.get('X-Rate-Limited') === '1';
          const payload = await response.json();
          if (rateLimitedHeader || payload.rate_limited) {
            setError('Reddit is rate limiting. Try fewer subreddits or wait a minute.');
          }
          const results = Array.isArray(payload.results) ? payload.results : [];
          const perSub = subs.map(sub => {
            const match = results.find(r => (r.subreddit || '').toLowerCase() === sub.toLowerCase());
            if (match) return {
              subreddit: match.subreddit,
              meta: match.meta || null,
              posts: match.posts || [],
              partial: Boolean(match.partial),
              error: match.error || null,
            };
            return { subreddit: sub, posts: [], meta: null, partial: false, error: null };
          });
          setNeedsAuth(false);
          setAuthenticated(true);
          setAuthChecking(false);
          setData(perSub);
          setFetchedAt(Date.now());

          // AI Ranking integration
          console.log('AI Ranking check:', { aiEnabled, hasGoals: Boolean(aiGoals && aiGoals.trim()), goalsLength: aiGoals?.length });
          if (aiEnabled && aiGoals && aiGoals.trim()) {
            try {
              // Simple hash function for goals comparison
              const hashGoals = (str) => {
                let hash = 0;
                for (let i = 0; i < str.length; i++) {
                  hash = ((hash << 5) - hash) + str.charCodeAt(i);
                  hash = hash & hash;
                }
                return hash.toString(36);
              };

              // Cache versioning: invalidate if goals, model, or prompt version changed
              const currentGoalsHash = hashGoals(aiGoals.trim());
              const CACHE_VERSION_KEY = 'dashboard_ai_cache_version';
              const MODEL_KEY = 'dashboard_ai_model';
              const savedModel = localStorage.getItem(MODEL_KEY) || 'unknown';
              const currentCacheVersion = `${currentGoalsHash}_v3.0_${savedModel}`; // v3.0 includes metadata + calibration
              
              try {
                const savedCacheVersion = localStorage.getItem(CACHE_VERSION_KEY);
                if (savedCacheVersion && savedCacheVersion !== currentCacheVersion) {
                  console.log('AI Ranking: Cache version changed (goals/model/prompt), clearing cached scores');
                  localStorage.removeItem('dashboard_ai_scores_cache');
                }
                localStorage.setItem(CACHE_VERSION_KEY, currentCacheVersion);
              } catch {}

              // Clear any cached 0 scores (they were from errors) - one-time cleanup
              try {
                const cacheStr = localStorage.getItem('dashboard_ai_scores_cache');
                if (cacheStr) {
                  const cache = JSON.parse(cacheStr);
                  let hasZeros = false;
                  Object.keys(cache).forEach(postId => {
                    if (cache[postId].score === 0) {
                      delete cache[postId];
                      hasZeros = true;
                    }
                  });
                  if (hasZeros) {
                    localStorage.setItem('dashboard_ai_scores_cache', JSON.stringify(cache));
                    console.log('AI Ranking: Cleared cached 0 scores (from previous errors)');
                  }
                }
              } catch {}
              
              // Load cached scores and metadata with version check
              // NOTE: We cache raw LLM scores (0-10) and always recalibrate on load
              // This ensures scores are relative to the current visible feed
              let cachedScores = new Map();
              let cachedMetadata = new Map();
              try {
                const cacheStr = localStorage.getItem('dashboard_ai_scores_cache');
                if (cacheStr) {
                  const cache = JSON.parse(cacheStr);
                  const now = Date.now();
                  const CACHE_EXPIRY = 24 * 60 * 60 * 1000; // 24 hours
                  Object.entries(cache).forEach(([postId, data]) => {
                    if (data.timestamp && (now - data.timestamp) < CACHE_EXPIRY) {
                      // Filter out 0 scores - they were likely assigned on error
                      // Only cache scores > 0 (legitimate scores are 1-10)
                      if (data.score > 0) {
                        cachedScores.set(postId, data.score);
                        // Load metadata if available
                        if (data.source || data.confidence || data.reason) {
                          cachedMetadata.set(postId, {
                            source: data.source || 'llm',
                            confidence: data.confidence || 'medium',
                            reason: data.reason || 'Cached relevance'
                          });
                        }
                      }
                    }
                  });
                  
                  // Clean up expired entries
                  const validEntries = Object.entries(cache).filter(([_, data]) => 
                    data.timestamp && (now - data.timestamp) < CACHE_EXPIRY && data.score > 0
                  );
                  if (validEntries.length < Object.keys(cache).length) {
                    localStorage.setItem('dashboard_ai_scores_cache', JSON.stringify(Object.fromEntries(validEntries)));
                    console.log(`AI Ranking: Cleaned up ${Object.keys(cache).length - validEntries.length} expired cache entries`);
                  }
                }
              } catch (cacheError) {
                console.warn('Error loading AI scores cache:', cacheError);
              }

              // Get all posts
              const allNewPosts = perSub.flatMap(g => g.posts || []);
              console.log(`AI Ranking: Found ${allNewPosts.length} total posts, ${cachedScores.size} cached scores`);
              
              // Filter out posts that already have cached scores
              const uncachedPosts = allNewPosts.filter(post => !cachedScores.has(String(post.id)));
              console.log(`AI Ranking: ${uncachedPosts.length} posts need scoring`);

              if (uncachedPosts.length > 0) {
                setAiRankingLoading(true);
                
                // Two-stage ranking: heuristic prefilter + LLM rerank
                const keywords = extractGoalKeywords(aiGoals.trim());
                console.log('AI Ranking: Extracted', keywords.length, 'keywords from goals:', keywords.slice(0, 10).join(', '));
                
                // Compute heuristic scores for all uncached posts
                const postsWithHeuristic = uncachedPosts.map(post => ({
                  post,
                  heuristicScore: computeHeuristicScore(post, keywords),
                }));
                
                // Sort by heuristic score and take top N for LLM ranking
                const MAX_LLM_POSTS = 60;
                postsWithHeuristic.sort((a, b) => b.heuristicScore - a.heuristicScore);
                const topPosts = postsWithHeuristic.slice(0, MAX_LLM_POSTS).map(x => x.post);
                const remainingPosts = postsWithHeuristic.slice(MAX_LLM_POSTS);
                
                console.log(`AI Ranking: Sending top ${topPosts.length} posts to LLM (${remainingPosts.length} will use heuristic scores only)`);
                
                // Batch posts into chunks of 50 to avoid payload size limits
                const BATCH_SIZE = 50;
                const batches = [];
                for (let i = 0; i < topPosts.length; i += BATCH_SIZE) {
                  batches.push(topPosts.slice(i, i + BATCH_SIZE));
                }
                console.log(`AI Ranking: Processing ${batches.length} batches of up to ${BATCH_SIZE} posts each`);
                
                try {
                  const allScores = new Map(cachedScores);
                  const allMetadata = new Map(cachedMetadata); // Store metadata for all scored posts
                  const cache = {};
                  
                  // Load existing cache
                  try {
                    const existingCache = localStorage.getItem('dashboard_ai_scores_cache');
                    if (existingCache) {
                      Object.assign(cache, JSON.parse(existingCache));
                    }
                  } catch {}
                  
                  // Process batches sequentially to avoid overwhelming the API
                  for (let batchIdx = 0; batchIdx < batches.length; batchIdx++) {
                    const batch = batches[batchIdx];
                    console.log(`AI Ranking: Processing batch ${batchIdx + 1}/${batches.length} (${batch.length} posts)`);
                    
                    try {
                      const response = await fetch('/api/reddit/ai-rank', {
                        method: 'POST',
                        credentials: 'include', // Include cookies for secure API key
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                          posts: batch.map(p => ({
                            id: p.id,
                            title: p.title,
                            selftext: p.selftext || '',
                            subreddit: p.subreddit,
                            url: p.reddit_url,
                            external_url: p.external_url,
                            domain: p.domain,
                            score: p.score,
                            num_comments: p.num_comments,
                            created_utc: p.created_utc,
                            link_flair_text: p.link_flair_text,
                          })),
                          userGoals: aiGoals.trim(),
                          // Only send key in body if not stored securely (fallback for migration)
                          openRouterApiKey: secureKeyStatus.hasKey ? undefined : (openRouterApiKey.trim() || undefined),
                          openRouterModel: openRouterModel.trim(), // Always required - has default in useState
                        }),
                      });

                      if (response.ok) {
                        const result = await response.json();
                        if (result.model) {
                          localStorage.setItem(MODEL_KEY, result.model);
                          const updatedCacheVersion = `${currentGoalsHash}_v3.0_${result.model}`;
                          if (updatedCacheVersion !== currentCacheVersion) {
                            console.log('AI Ranking: Model changed, clearing cached scores');
                            localStorage.removeItem('dashboard_ai_scores_cache');
                            localStorage.setItem(CACHE_VERSION_KEY, updatedCacheVersion);
                          }
                        }
                        // New format: scores is an object map {postId: score}
                        // Old format: scores is an array [{postId, relevanceScore}]
                        const scoresObj = result.scores || {};
                        const metadataObj = result.metadata || {};
                        const scoreCount = typeof scoresObj === 'object' && !Array.isArray(scoresObj) 
                          ? Object.keys(scoresObj).length 
                          : (Array.isArray(scoresObj) ? scoresObj.length : 0);
                        console.log(`AI Ranking: Batch ${batchIdx + 1} - Received scores for`, scoreCount, 'posts', result.cached ? `(${result.cached} cached)` : '');
                        
                        // Handle new object map format
                        if (scoresObj && typeof scoresObj === 'object' && !Array.isArray(scoresObj)) {
                          Object.entries(scoresObj).forEach(([postId, relevanceScore]) => {
                            const postIdStr = String(postId);
                            // Only cache non-null scores (null means failed to score)
                            if (relevanceScore !== null && relevanceScore !== undefined) {
                              allScores.set(postIdStr, relevanceScore);
                              
                              // Extract metadata if available
                              const meta = metadataObj[postId] || {};
                              allMetadata.set(postIdStr, {
                                source: 'llm',
                                confidence: meta.confidence || 'medium',
                                reason: meta.reason || 'LLM-scored relevance'
                              });
                              
                              cache[postIdStr] = { 
                                score: relevanceScore, 
                                timestamp: Date.now(),
                                version: result.promptVersion || 'v2.0',
                                model: result.model || 'unknown',
                                confidence: meta.confidence || 'medium',
                                reason: meta.reason || 'LLM-scored relevance',
                                source: 'llm'
                              };
                            } else {
                              // Track null scores but don't cache them
                              allScores.set(postIdStr, null);
                            }
                          });
                        } else if (Array.isArray(scoresObj)) {
                          // Fallback: handle old array format for backwards compatibility
                          scoresObj.forEach(({ postId, relevanceScore }) => {
                            const postIdStr = String(postId);
                            if (relevanceScore !== null && relevanceScore !== undefined) {
                              allScores.set(postIdStr, relevanceScore);
                              allMetadata.set(postIdStr, {
                                source: 'llm',
                                confidence: 'medium',
                                reason: 'LLM-scored relevance'
                              });
                              cache[postIdStr] = { 
                                score: relevanceScore, 
                                timestamp: Date.now(),
                                version: result.promptVersion || 'v1.0',
                                model: result.model || 'unknown',
                                confidence: 'medium',
                                reason: 'LLM-scored relevance',
                                source: 'llm'
                              };
                            } else {
                              allScores.set(postIdStr, null);
                            }
                          });
                        }
                        
                        // Log failed post IDs if provided
                        if (result.failedPostIds && result.failedPostIds.length > 0) {
                          console.warn(`AI Ranking: ${result.failedPostIds.length} posts failed to score:`, result.failedPostIds);
                        }
                      } else {
                        const errorText = await response.text();
                        console.error(`AI ranking API error for batch ${batchIdx + 1}:`, response.status, errorText);
                      }
                    } catch (batchError) {
                      console.error(`Error processing batch ${batchIdx + 1}:`, batchError);
                    }
                    
                    // Small delay between batches to avoid rate limiting
                    if (batchIdx < batches.length - 1) {
                      await new Promise(resolve => setTimeout(resolve, 500));
                    }
                  }
                  
                  // Save updated cache with LRU eviction (max 5000 entries)
                  try {
                    const MAX_CACHE_ENTRIES = 5000;
                    const entries = Object.entries(cache);
                    if (entries.length > MAX_CACHE_ENTRIES) {
                      // Sort by timestamp (oldest first) and keep only newest entries
                      entries.sort((a, b) => (a[1].timestamp || 0) - (b[1].timestamp || 0));
                      const toKeep = entries.slice(-MAX_CACHE_ENTRIES);
                      const trimmedCache = Object.fromEntries(toKeep);
                      localStorage.setItem('dashboard_ai_scores_cache', JSON.stringify(trimmedCache));
                      console.log(`AI Ranking: Trimmed cache from ${entries.length} to ${MAX_CACHE_ENTRIES} entries`);
                    } else {
                      localStorage.setItem('dashboard_ai_scores_cache', JSON.stringify(cache));
                    }
                  } catch (cacheError) {
                    console.warn('Error saving AI scores cache:', cacheError);
                    // If quota exceeded, clear cache and retry
                    if (cacheError.name === 'QuotaExceededError') {
                      try {
                        localStorage.removeItem('dashboard_ai_scores_cache');
                        console.log('AI Ranking: Cleared cache due to quota exceeded');
                      } catch {}
                    }
                  }
                  
                  // Add heuristic scores for remaining posts (map to 0-10 range, will be calibrated)
                  remainingPosts.forEach(({ post, heuristicScore }) => {
                    const postId = String(post.id);
                    if (!allScores.has(postId)) {
                      // Map heuristic score to 0-10 range (max observed heuristic ~15-20)
                      const normalizedScore = Math.min(10, Math.round(heuristicScore * 0.6));
                      allScores.set(postId, normalizedScore);
                      allMetadata.set(postId, { source: 'heuristic', confidence: 'low', reason: 'Keyword-based relevance' });
                    }
                  });
                  
                  // Apply percentile-based calibration to all scores
                  const calibratedScores = calibrateScores(allScores);
                  
                  const highRelevanceCount = Array.from(calibratedScores.values()).filter(s => s !== null && s !== undefined && s >= 7).length;
                  console.log(`AI Ranking: Complete! ${calibratedScores.size} total scores (${topPosts.length} from LLM, ${remainingPosts.length} from heuristic), ${highRelevanceCount} posts scored >= 7 after calibration`);
                  
                  // Update cache with calibrated scores
                  try {
                    calibratedScores.forEach((calibratedScore, postId) => {
                      if (cache[postId] && calibratedScore !== null && calibratedScore !== undefined) {
                        cache[postId].score = calibratedScore;
                      }
                    });
                    localStorage.setItem('dashboard_ai_scores_cache', JSON.stringify(cache));
                    console.log('AI Ranking: Saved calibrated scores to cache');
                  } catch (cacheError) {
                    console.warn('Error saving calibrated scores:', cacheError);
                  }
                  
                  setPostRelevanceScores(calibratedScores);
                  setPostRelevanceMetadata(allMetadata);
                  setScoresVersion(v => v + 1); // Increment version to trigger useMemo recalculation
                } catch (aiError) {
                  console.error('Error in AI ranking batch processing:', aiError);
                  // Use cached scores on error (with calibration)
                  const calibratedCached = calibrateScores(cachedScores);
                  setPostRelevanceScores(calibratedCached);
                  setPostRelevanceMetadata(cachedMetadata);
                  setScoresVersion(v => v + 1); // Increment version to trigger useMemo recalculation
                } finally {
                  setAiRankingLoading(false);
                }
              } else {
                // All posts are cached, use cached scores with calibration
                console.log('AI Ranking: All posts already cached, using cached scores');
                const calibratedCached = calibrateScores(cachedScores);
                const highRelevanceCount = Array.from(calibratedCached.values()).filter(s => s !== null && s !== undefined && s >= 7).length;
                console.log(`AI Ranking: ${highRelevanceCount} cached posts scored >= 7 after calibration`);
                setPostRelevanceScores(calibratedCached);
                setPostRelevanceMetadata(cachedMetadata);
                setScoresVersion(v => v + 1); // Increment version to trigger useMemo recalculation
              }
            } catch (aiError) {
              console.error('Error in AI ranking integration:', aiError);
              setAiRankingLoading(false);
            }
          } else {
            // Clear scores if AI is disabled or goals not set
            console.log('AI Ranking: Disabled or no goals set');
            setPostRelevanceScores(new Map());
            setPostRelevanceMetadata(new Map());
            setScoresVersion(v => v + 1); // Increment version to trigger useMemo recalculation
          }

          // Check for notifications on auto-refresh
          if (triggeredByAuto && notificationsEnabled && Notification.permission === 'granted') {
            const allNewPosts = perSub.flatMap(g => g.posts || []);
            // Check for upvote threshold crossing
            allNewPosts.forEach(post => {
              const prevScore = previousPostScores.get(post.id);
              const currentScore = Number(post.score) || 0;
              if (prevScore !== undefined && prevScore < upvoteThreshold && currentScore >= upvoteThreshold) {
                new Notification('Post crossed threshold!', { body: `"${post.title}" now has ${currentScore} upvotes`, icon: '/favicon.ico' });
              }
            });
            // Check for keyword matches in new posts
            if (alertKeywords.trim()) {
              const keywords = alertKeywords.toLowerCase().split(',').map(k => k.trim()).filter(Boolean);
              allNewPosts.forEach(post => {
                if (!previousPostScores.has(post.id)) {
                  const title = (post.title || '').toLowerCase();
                  const selftext = (post.selftext || '').toLowerCase();
                  const matchedKeyword = keywords.find(kw => title.includes(kw) || selftext.includes(kw));
                  if (matchedKeyword) {
                    new Notification(`Keyword "${matchedKeyword}" found!`, { body: post.title, icon: '/favicon.ico' });
                  }
                }
              });
            }
            // Update previous scores
            const newScores = new Map();
            allNewPosts.forEach(post => newScores.set(post.id, Number(post.score) || 0));
            setPreviousPostScores(newScores);
          }
        } catch (fetchError) {
          setNeedsAuth(false);
          if (fetchError?.name === 'AbortError') {
            setError(`Request timed out. Reddit may be slow. Try again.`);
          } else {
            setError(fetchError.message || 'Failed to fetch');
          }
          setData([]);
          setFetchedAt(null);
        } finally {
          clearTimeout(timeoutId);
          setLoading(false);
          if (autoRefreshEnabled && subs.length) {
            setNextRefreshAt(Date.now() + autoRefreshInterval * 60 * 1000);
          } else {
            setNextRefreshAt(null);
          }
          if (triggeredByAuto) setLastAutoRefreshAt(Date.now());
        }
      }, [subs, mode, time, days, limit, maxPages, autoRefreshEnabled, autoRefreshInterval, notificationsEnabled, upvoteThreshold, alertKeywords, previousPostScores, aiEnabled, aiGoals, secureKeyStatus.hasKey, openRouterApiKey, openRouterModel]);

      const refreshRef = useRef(refresh);
      useEffect(() => { refreshRef.current = refresh; }, [refresh]);

      useEffect(() => {
        if (!autoRefreshEnabled) setLastAutoRefreshAt(null);
      }, [autoRefreshEnabled]);

      useEffect(() => {
        if (!autoRefreshEnabled || !subs.length) {
          setNextRefreshAt(null);
          return () => {};
        }
        const intervalMs = Math.max(MIN_AUTO_REFRESH_MINUTES, autoRefreshInterval) * 60 * 1000;
        setNextRefreshAt(Date.now() + intervalMs);
        let cancelled = false;
        const triggerRefresh = () => {
          if (cancelled || loadingRef.current || !subs.length) return;
          refreshRef.current({ triggeredByAuto: true });
        };
        // Only use interval - no immediate kickoff to avoid race conditions
        const intervalId = setInterval(triggerRefresh, intervalMs);
        return () => { cancelled = true; clearInterval(intervalId); };
      }, [autoRefreshEnabled, autoRefreshInterval, subs.length]);

      const handleAddSub = useCallback((name) => {
        const normalized = normalizeSubredditName(name);
        if (!normalized) return;
        setSubs(prev => {
          if (prev.some(s => s.toLowerCase() === normalized.toLowerCase())) return prev;
          return [...prev, normalized];
        });
      }, []);

      const handleRemoveSub = useCallback((name) => {
        setSubs(prev => prev.filter(s => s.toLowerCase() !== name.toLowerCase()));
        if (selectedSub.toLowerCase() === name.toLowerCase()) setSelectedSub('ALL');
      }, [selectedSub]);

      const handleAddSubSubmit = useCallback(() => {
        const names = addSubInput.split(/[,\n]+/).map(s => normalizeSubredditName(s)).filter(Boolean);
        if (names.length === 0) return;
        setSubs(prev => {
          const existing = new Set(prev.map(s => s.toLowerCase()));
          const newOnes = names.filter(n => !existing.has(n.toLowerCase()));
          return [...prev, ...newOnes];
        });
        setAddSubInput('');
        setAddSubOpen(false);
      }, [addSubInput]);

      const handleApplyStarterPack = useCallback((pack) => {
        if (!pack?.subs) return;
        setSubs(prev => {
          const existing = new Set(prev.map(s => s.toLowerCase()));
          const newOnes = pack.subs.filter(s => !existing.has(s.toLowerCase()));
          return [...prev, ...newOnes];
        });
      }, []);

      // Keyboard shortcut for search
      useEffect(() => {
        const handler = (e) => {
          if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
            e.preventDefault();
            document.getElementById('search-input')?.focus();
          }
          if (e.key === 'Escape') {
            setActivePostMenu(null);
            setHoverPost(null);
          }
        };
        window.addEventListener('keydown', handler);
        return () => window.removeEventListener('keydown', handler);
      }, []);

      // Close menu when clicking outside
      useEffect(() => {
        const handler = () => setActivePostMenu(null);
        if (activePostMenu) {
          document.addEventListener('click', handler);
          return () => document.removeEventListener('click', handler);
        }
      }, [activePostMenu]);

      // Quick action handlers
      const handleCopyLink = useCallback((post) => {
        const url = post.reddit_url || post.external_url || '';
        navigator.clipboard.writeText(url);
        setActivePostMenu(null);
      }, []);

      const handleHidePost = useCallback((postId) => {
        setHiddenPosts(prev => new Set([...prev, postId]));
        setActivePostMenu(null);
        if (selectedPost?.id === postId) setSelectedPost(null);
      }, [selectedPost]);

      const handlePostHoverStart = useCallback((post) => {
        if (hoverTimeoutRef.current) clearTimeout(hoverTimeoutRef.current);
        hoverTimeoutRef.current = setTimeout(() => setHoverPost(post), 500);
      }, []);

      const handlePostHoverEnd = useCallback(() => {
        if (hoverTimeoutRef.current) {
          clearTimeout(hoverTimeoutRef.current);
          hoverTimeoutRef.current = null;
        }
        setHoverPost(null);
      }, []);

      // Cleanup hover timeout on unmount
      useEffect(() => {
        return () => {
          if (hoverTimeoutRef.current) {
            clearTimeout(hoverTimeoutRef.current);
          }
        };
      }, []);

      // Save API key securely (HttpOnly cookie)
      const saveSecureApiKey = useCallback(async () => {
        if (!openRouterApiKey.trim()) return;
        setSavingSecureKey(true);
        try {
          const response = await fetch('/api/settings/openrouter-key', {
            method: 'POST',
            credentials: 'include',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ apiKey: openRouterApiKey.trim() })
          });
          if (response.ok) {
            const data = await response.json();
            setSecureKeyStatus({ hasKey: true, keyPreview: data.keyPreview, checking: false });
            // Clear localStorage version for security
            try { localStorage.removeItem('dashboard_openrouter_api_key'); } catch {}
            setOpenRouterApiKey(''); // Clear from state too
            alert('API key saved securely! It is now stored in an HttpOnly cookie and cannot be accessed by JavaScript.');
          } else {
            const error = await response.json();
            alert('Failed to save API key: ' + (error.error || 'Unknown error'));
          }
        } catch (e) {
          alert('Failed to save API key: ' + e.message);
        } finally {
          setSavingSecureKey(false);
        }
      }, [openRouterApiKey]);

      // Delete secure API key
      const deleteSecureApiKey = useCallback(async () => {
        if (!confirm('Remove the securely stored API key?')) return;
        try {
          const response = await fetch('/api/settings/openrouter-key', {
            method: 'DELETE',
            credentials: 'include'
          });
          if (response.ok) {
            setSecureKeyStatus({ hasKey: false, keyPreview: null, checking: false });
          }
        } catch (e) {
          alert('Failed to remove API key: ' + e.message);
        }
      }, []);

      const filtersActive = minUpvoteFilter || minCommentFilter || minAiRelevance || keyword;

      return h('div', { 
        className: 'h-screen flex flex-col',
        onTouchStart: handleTouchStart,
        onTouchEnd: handleTouchEnd
      },
        // Header
        h('header', { className: 'bg-white dark:bg-zinc-800 border-b border-zinc-200 dark:border-zinc-700 px-4 py-3 flex items-center justify-between gap-4 shrink-0' },
            h('div', { className: 'flex items-center gap-3' },
            h('h1', { className: 'text-lg font-bold text-zinc-900 dark:text-white' }, 'Reddit Dashboarder'),
            ),
            h('div', { className: 'flex items-center gap-2' },
              // Dark mode toggle
              h('button', {
                onClick: () => setDarkMode(!darkMode),
                className: 'p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-700 text-zinc-600 dark:text-zinc-400 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900',
                title: darkMode ? 'Light mode' : 'Dark mode'
              }, darkMode 
                ? h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                    h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z' })
                  )
                : h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                    h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z' })
                  )
              ),
              h('button', {
                onClick: () => setSettingsOpen(true),
              className: 'p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-700 text-zinc-600 dark:text-zinc-400 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900',
              title: 'Settings'
            }, h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z' }),
                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' })
            )),
              authChecking
              ? h('div', { className: 'px-3 py-1.5 text-sm text-zinc-500' }, 'Checkingâ€¦')
                : authenticated
                  ? h('button', {
                      onClick: () => { window.location.href = '/api/auth/logout'; },
                    className: 'px-3 py-1.5 rounded-lg text-sm font-medium text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900'
                    }, 'Sign out')
                  : h('button', {
                      onClick: () => { window.location.href = '/api/auth/start'; },
                    className: 'px-3 py-1.5 rounded-lg text-sm font-medium bg-zinc-900 dark:bg-indigo-600 text-white hover:bg-zinc-800 dark:hover:bg-indigo-700 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900'
                    }, 'Sign in')
          )
        ),

        // Status bar
        h('div', { className: 'bg-zinc-50 dark:bg-zinc-800/50 border-b border-zinc-200 dark:border-zinc-700 px-4 py-2 flex items-center justify-between gap-4 text-sm shrink-0' },
          h('div', { className: 'flex items-center gap-4' },
            loading
              ? h('span', { className: 'flex items-center gap-2 text-zinc-600 dark:text-zinc-400' },
                  h('div', { className: 'w-3 h-3 border-2 border-zinc-300 dark:border-zinc-600 border-t-zinc-600 dark:border-t-zinc-300 rounded-full animate-spin' }),
                  'Fetchingâ€¦'
                )
              : error
                ? h('span', { className: 'text-rose-600 dark:text-rose-400 font-medium' }, error)
                : needsAuth
                  ? h('span', { className: 'text-amber-700 dark:text-amber-400 font-medium' }, 'Sign in required')
                  : h('span', { className: 'text-zinc-600 dark:text-zinc-400' },
                      visiblePosts.length > 0
                        ? `${visiblePosts.length} posts`
                        : subs.length > 0 ? 'No posts found' : 'Add subreddits to start'
                    ),
            fetchedAt && !loading && h('span', { className: 'text-zinc-400 dark:text-zinc-500' }, `Updated ${timeAgo(fetchedAt / 1000)}`),
            autoRefreshEnabled && nextRefreshAt && !loading && h('span', { className: 'text-zinc-400 dark:text-zinc-500' }, `â€¢ Next ${formatTimeUntil(nextRefreshAt)}`),
            aiRankingLoading && h('span', { className: 'text-emerald-700 dark:text-emerald-300 font-medium' }, 'â€¢ AI Ranking...'),
            !aiRankingLoading && aiEnabled && aiGoals && aiGoals.trim() && h('span', { className: 'text-emerald-700 dark:text-emerald-300' }, 'â€¢ AI Active'),
            !aiRankingLoading && (!aiEnabled || !aiGoals || !aiGoals.trim()) && postRelevanceScores.size === 0 && h('span', { className: 'text-zinc-500 text-xs' }, 'â€¢ AI Inactive')
          ),
          h('button', {
            onClick: () => refresh(),
            disabled: loading,
            className: 'flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-zinc-900 dark:bg-indigo-600 text-white text-sm font-medium hover:bg-zinc-800 dark:hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900'
          },
            h('svg', { className: `w-4 h-4 ${loading ? 'animate-spin' : ''}`, fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
              h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15' })
            ),
            'Refresh'
          )
        ),

        // Main content area
        h('div', { className: 'flex-1 flex overflow-hidden' },
          // Left sidebar - Subreddits
          h('aside', { className: `w-52 bg-white dark:bg-zinc-800 border-r border-zinc-200 dark:border-zinc-700 flex-col shrink-0 ${mobileView === 'subs' ? 'flex' : 'hidden lg:flex'}` },
            h('div', { className: 'p-3 border-b border-zinc-200 dark:border-zinc-700 flex items-center justify-between' },
              h('span', { className: 'text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400' }, 'Subreddits'),
                h('button', {
                onClick: () => { setAddSubOpen(true); setTimeout(() => addSubInputRef.current?.focus(), 50); },
                className: 'p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-700 text-zinc-600 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-300 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900',
                title: 'Add subreddit'
              }, h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 4v16m8-8H4' })
              ))
            ),
            h('div', { className: 'flex-1 overflow-auto scrollbar-thin p-2 space-y-1' },
              subs.length === 0
                ? h('div', { className: 'p-4 text-center' },
                    // Better empty state with icon
                    h('div', { className: 'w-16 h-16 mx-auto mb-4 rounded-full bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center' },
                      h('svg', { className: 'w-8 h-8 text-zinc-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M21 12a9 9 0 01-9 9m9-9a9 9 0 00-9-9m9 9H3m9 9a9 9 0 01-9-9m9 9c1.657 0 3-4.03 3-9s-1.343-9-3-9m0 18c-1.657 0-3-4.03-3-9s1.343-9 3-9m-9 9a9 9 0 019-9' })
                      )
                    ),
                    h('h3', { className: 'text-lg font-semibold text-zinc-900 dark:text-white mb-2' }, 'Welcome!'),
                    h('p', { className: 'text-sm text-zinc-500 dark:text-zinc-400 text-center max-w-xs mb-4' }, 'Get started with a starter pack'),
                    h('div', { className: 'space-y-2' },
                      STARTER_PACKS.map(pack =>
                        h('button', {
                          key: pack.id,
                          onClick: () => handleApplyStarterPack(pack),
                          className: 'w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-600 hover:border-zinc-300 dark:hover:border-zinc-500 hover:bg-zinc-50 dark:hover:bg-zinc-700 text-left text-sm transition-colors'
                        },
                          h('span', { className: 'mr-1.5' }, pack.emoji),
                          h('span', { className: 'text-zinc-700 dark:text-zinc-300' }, pack.label)
                        )
                      )
                    ),
                    h('button', {
                      onClick: () => { setAddSubOpen(true); setTimeout(() => addSubInputRef.current?.focus(), 50); },
                      className: 'mt-3 text-xs text-indigo-600 dark:text-indigo-400 hover:text-indigo-700 dark:hover:text-indigo-300 font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900'
                    }, '+ Add custom')
                  )
                : [
                    h('button', {
                      key: 'all',
                      onClick: () => setSelectedSub('ALL'),
                      className: `w-full px-3 py-2 rounded-lg text-left text-sm font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900 ${selectedSub === 'ALL' ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-400' : 'hover:bg-zinc-50 dark:hover:bg-zinc-700 text-zinc-700 dark:text-zinc-300'}`
                    },
                      h('div', { className: 'flex items-center justify-between' },
                        h('span', null, 'All'),
                        h('span', { className: 'text-xs text-zinc-400 dark:text-zinc-500' }, allPosts.length)
                      )
                    ),
                    ...subs.map(sub => {
                      const postCount = allPosts.filter(p => p.subreddit?.toLowerCase() === sub.toLowerCase()).length;
                      const isSelected = selectedSub.toLowerCase() === sub.toLowerCase();
                    const meta = subMetaMap.get(sub) || {};
                      return h('div', {
                      key: sub,
                        className: `group rounded-lg transition-colors ${isSelected ? 'bg-indigo-50 dark:bg-indigo-900/30' : 'hover:bg-zinc-50 dark:hover:bg-zinc-700'}`
                      },
                        h('button', {
                      onClick: () => setSelectedSub(sub),
                          className: `w-full px-3 py-2 text-left focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900`
                    },
                      h('div', { className: 'flex items-center justify-between' },
                            h('span', { className: `text-sm font-medium ${isSelected ? 'text-indigo-700 dark:text-indigo-400' : 'text-zinc-700 dark:text-zinc-300'}` }, `r/${sub}`),
                        h('div', { className: 'flex items-center gap-2' },
                              h('span', { className: 'text-xs text-zinc-400 dark:text-zinc-500' }, postCount),
                          h('button', {
                                onClick: (e) => { e.stopPropagation(); handleRemoveSub(sub); },
                                className: 'opacity-0 group-hover:opacity-100 p-0.5 rounded hover:bg-zinc-200 dark:hover:bg-zinc-600 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 transition-all focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900',
                            title: 'Remove'
                              }, h('svg', { className: 'w-3 h-3', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                              h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
                              ))
                            )
                          ),
                          meta.subscribers && h('div', { className: 'text-[11px] text-zinc-400 dark:text-zinc-500 mt-0.5' }, `${formatSubs(meta.subscribers)} members`)
                        )
                      );
                    })
                  ]
            )
          ),

          // Center - Post list
          h('main', { className: `flex-1 flex-col bg-zinc-50 dark:bg-zinc-900 min-w-0 ${detailCollapsed ? '' : 'lg:border-r lg:border-zinc-200 dark:lg:border-zinc-700'} ${mobileView === 'posts' ? 'flex' : 'hidden lg:flex'}` },
            // Filter toolbar
            h('div', { className: 'bg-white dark:bg-zinc-800 border-b border-zinc-200 dark:border-zinc-700 px-4 py-2.5 flex items-center gap-3 shrink-0 flex-wrap' },
              h('div', { className: 'relative flex-1 min-w-[120px] max-w-[180px]' },
                h('svg', { className: 'absolute left-3 top-1/2 -translate-y-1/2 w-4 h-4 text-zinc-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z' })
                ),
                h('input', {
                  id: 'search-input',
                  type: 'text',
                  value: keyword,
                  onChange: (e) => setKeyword(e.target.value),
                  placeholder: 'Search keywordsâ€¦ (âŒ˜K)',
                  className: 'w-full pl-9 pr-3 py-1.5 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-zinc-900 focus:border-transparent'
                })
              ),
              h('div', { className: 'hidden sm:flex items-center gap-1.5' },
                h('span', { className: 'text-xs text-zinc-500 dark:text-zinc-400 mr-1' }, 'â–²'),
                UPVOTE_PRESETS.map(preset =>
                  h('button', {
                    key: `upvote-${preset.value}`,
                    onClick: () => setMinUpvoteFilter(minUpvoteFilter === preset.value ? '' : preset.value),
                    className: `px-2.5 py-1 rounded-full text-xs font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900 ${minUpvoteFilter === preset.value ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' : 'bg-zinc-100 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 hover:bg-zinc-200 dark:hover:bg-zinc-600'}`
                  }, preset.label)
                )
              ),
              h('div', { className: 'hidden sm:flex items-center gap-1.5' },
                h('span', { className: 'text-xs text-zinc-500 dark:text-zinc-400 mr-1' }, 'ðŸ’¬'),
                COMMENT_PRESETS.map(preset =>
                  h('button', {
                    key: `comment-${preset.value}`,
                    onClick: () => setMinCommentFilter(minCommentFilter === preset.value ? '' : preset.value),
                    className: `px-2.5 py-1 rounded-full text-xs font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900 ${minCommentFilter === preset.value ? 'bg-indigo-50 dark:bg-indigo-900/30 text-indigo-700 dark:text-indigo-300' : 'bg-zinc-100 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 hover:bg-zinc-200 dark:hover:bg-zinc-600'}`
                  }, preset.label)
                )
              ),
              // AI relevance filter (only show when AI is enabled and scores are available)
              aiEnabled && aiGoals && aiGoals.trim() && postRelevanceScores.size > 0 && h('div', { className: 'hidden sm:flex items-center gap-1.5' },
                h('span', { className: 'text-xs text-zinc-500 dark:text-zinc-400 mr-1' }, 'ðŸ¤–'),
                AI_RELEVANCE_PRESETS.map(preset =>
                  h('button', {
                    key: `ai-${preset.value}`,
                    onClick: () => setMinAiRelevance(minAiRelevance === preset.value ? '' : preset.value),
                    className: `px-2.5 py-1 rounded-full text-xs font-medium transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900 ${minAiRelevance === preset.value ? 'bg-emerald-50 dark:bg-emerald-900/30 text-emerald-700 dark:text-emerald-300' : 'bg-zinc-100 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 hover:bg-zinc-200 dark:hover:bg-zinc-600'}`
                  }, preset.label)
                )
              ),
              h('select', {
                value: `${sortBy}-${sortOrder}`,
                onChange: (e) => {
                  const value = e.target.value;
                  // Handle special case: "ai-relevance-desc" or "ai-relevance-asc"
                  let by, order;
                  if (value.startsWith('ai-relevance-')) {
                    by = 'ai-relevance';
                    order = value.replace('ai-relevance-', '');
                  } else {
                    // For other sorts like "date-desc", "upvotes-asc", etc.
                    const lastDashIndex = value.lastIndexOf('-');
                    by = value.substring(0, lastDashIndex);
                    order = value.substring(lastDashIndex + 1);
                  }
                  console.log('Sort changed:', { value, by, order, previous: { sortBy, sortOrder } });
                  setSortBy(by);
                  setSortOrder(order);
                },
                className: 'px-2 py-1 rounded-lg border border-zinc-200 dark:border-zinc-600 text-xs bg-white dark:bg-zinc-700 dark:text-white'
              },
                h('option', { value: 'date-desc' }, 'Newest'),
                h('option', { value: 'date-asc' }, 'Oldest'),
                h('option', { value: 'upvotes-desc' }, 'Most upvotes'),
                h('option', { value: 'upvotes-asc' }, 'Least upvotes'),
                h('option', { value: 'comments-desc' }, 'Most comments'),
                h('option', { value: 'comments-asc' }, 'Least comments'),
                aiEnabled && aiGoals && aiGoals.trim() && postRelevanceScores.size > 0 && [
                  h('option', { key: 'ai-desc', value: 'ai-relevance-desc' }, 'ðŸ¤– Highest AI relevance'),
                  h('option', { key: 'ai-asc', value: 'ai-relevance-asc' }, 'ðŸ¤– Lowest AI relevance')
                ]
              ),
                filtersActive && h('button', {
                onClick: () => { setMinUpvoteFilter(''); setMinCommentFilter(''); setMinAiRelevance(''); setKeyword(''); },
                className: 'text-xs text-zinc-500 dark:text-zinc-400 hover:text-zinc-700 dark:hover:text-zinc-300'
              }, 'Clear')
            ),

            // Post list
            h('div', { className: 'flex-1 overflow-auto scrollbar-thin relative' },
              visiblePosts.length === 0
                ? h('div', { className: 'flex flex-col items-center justify-center h-full p-8' },
                    subs.length === 0 
                      ? [
                          h('div', { key: 'icon', className: 'w-16 h-16 mb-4 rounded-full bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center' },
                            h('svg', { className: 'w-8 h-8 text-zinc-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                              h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10' })
                            )
                          ),
                          h('h3', { key: 'title', className: 'text-lg font-semibold text-zinc-900 dark:text-white mb-2' }, 'No subreddits yet'),
                          h('p', { key: 'desc', className: 'text-sm text-zinc-500 dark:text-zinc-400 text-center max-w-xs' }, 'Add your favorite subreddits from the sidebar or try one of our starter packs')
                        ]
                      : loading 
                        ? h('span', { className: 'text-zinc-500 dark:text-zinc-400 text-sm' }, 'Loadingâ€¦')
                        : [
                            h('div', { key: 'icon', className: 'w-16 h-16 mb-4 rounded-full bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center' },
                              h('svg', { className: 'w-8 h-8 text-zinc-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M3 4a1 1 0 011-1h16a1 1 0 011 1v2.586a1 1 0 01-.293.707l-6.414 6.414a1 1 0 00-.293.707V17l-4 4v-6.586a1 1 0 00-.293-.707L3.293 7.293A1 1 0 013 6.586V4z' })
                              )
                            ),
                            h('h3', { key: 'title', className: 'text-lg font-semibold text-zinc-900 dark:text-white mb-2' }, 'No posts match'),
                            h('p', { key: 'desc', className: 'text-sm text-zinc-500 dark:text-zinc-400 text-center max-w-xs mb-4' }, 'Try adjusting your filters or search for different keywords'),
                            h('button', { 
                              key: 'clear',
                              onClick: () => { setMinUpvoteFilter(''); setMinCommentFilter(''); setMinAiRelevance(''); setKeyword(''); },
                              className: 'px-4 py-2 rounded-lg text-sm font-medium bg-zinc-900 text-white hover:bg-zinc-800 dark:bg-indigo-600 dark:hover:bg-indigo-700 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900'
                            }, 'Clear all filters')
                          ]
                  )
                : h('div', { className: 'divide-y divide-zinc-200 dark:divide-zinc-700' },
                    visiblePosts.map(post => {
                        const isSelected = selectedPost?.id === post.id;
                        const score = Number(post.score) || 0;
                        const comments = Number(post.num_comments) || 0;
                        const flair = post.link_flair_text;
                        const flairBg = post.link_flair_background_color || '#e4e4e7';
                        const flairTextColor = post.link_flair_text_color === 'light' ? '#fff' : '#18181b';
                        const relevanceScore = postRelevanceScores.get(String(post.id));
                        const relevanceMeta = postRelevanceMetadata.get(String(post.id));
                        const isHighlyRelevant = relevanceScore !== undefined && relevanceScore !== null && relevanceScore >= 7;
                        const isVeryHighRelevant = relevanceScore !== undefined && relevanceScore !== null && relevanceScore >= 8;
                        // Debug: log first post's score retrieval
                        if (visiblePosts.indexOf(post) === 0) {
                          console.log('Post rendering debug:', {
                            postId: post.id,
                            postIdString: String(post.id),
                            relevanceScore,
                            relevanceMeta,
                            isHighlyRelevant,
                            scoresMapSize: postRelevanceScores.size,
                            aiEnabled,
                            hasGoals: Boolean(aiGoals && aiGoals.trim())
                          });
                        }
                        const borderClass = isSelected 
                          ? 'border-l-2 border-indigo-500' 
                          : isHighlyRelevant 
                            ? 'border-l-4 border-emerald-500' 
                            : '';
                        const bgClass = isSelected 
                          ? 'bg-white dark:bg-zinc-800'
                          : isVeryHighRelevant
                            ? 'bg-emerald-50/50 dark:bg-emerald-950/20'
                            : 'bg-zinc-50 dark:bg-zinc-900';
                        return h('div', {
                          key: post.id,
                          className: `group relative w-full text-left px-4 py-3 hover:bg-white dark:hover:bg-zinc-800 transition-colors ${bgClass} ${borderClass}`,
                          onMouseEnter: () => handlePostHoverStart(post),
                          onMouseLeave: handlePostHoverEnd
                        },
                          h('button', {
                            onClick: () => { setSelectedPost(post); setDetailCollapsed(false); setMobileView('detail'); },
                            className: 'w-full text-left'
                          },
                            h('div', { className: 'flex gap-3' },
                              post.thumbnail && post.thumbnail !== 'self' && post.thumbnail !== 'default' && post.thumbnail !== 'nsfw' && h('img', {
                                src: post.thumbnail,
                                alt: '',
                                className: 'w-16 h-16 object-cover rounded-lg shrink-0 bg-zinc-200 dark:bg-zinc-700'
                              }),
                              h('div', { className: 'flex-1 min-w-0' },
                                h('div', { className: 'flex items-center gap-2 text-xs text-zinc-500 dark:text-zinc-400 mb-1 flex-wrap' },
                                  h('span', null, `r/${post.subreddit}`),
                                  flair && h('span', { 
                                    className: 'px-1.5 py-0.5 rounded-full text-[10px] font-medium',
                                    style: { backgroundColor: flairBg, color: flairTextColor }
                                  }, flair),
                                  h('span', null, 'â€¢'),
                                  h('span', null, timeAgo(post.created_utc)),
                                  relevanceScore !== undefined && relevanceScore !== null && h('span', {
                                    className: `px-1.5 py-0.5 rounded text-[10px] font-bold ${
                                      relevanceScore >= 8 ? 'bg-emerald-600 text-white' :
                                      relevanceScore >= 7 ? 'bg-emerald-100 dark:bg-emerald-900/60 text-emerald-700 dark:text-emerald-200' :
                                      relevanceScore >= 5 ? 'bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-200' :
                                      'bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-400'
                                    }`,
                                    title: relevanceMeta ? `AI Relevance: ${relevanceScore}/10 â€¢ ${relevanceMeta.confidence} confidence â€¢ ${relevanceMeta.reason}` : `AI Relevance: ${relevanceScore}/10`
                                  }, `AI ${relevanceScore}`)
                                ),
                                h('h3', { className: 'text-sm font-medium text-zinc-900 dark:text-white leading-snug line-clamp-2' }, post.title),
                                h('div', { className: 'flex items-center gap-3 mt-1.5 text-xs' },
                                  h('span', { className: 'text-emerald-700 dark:text-emerald-400 font-medium' }, `â–² ${score}`),
                                  h('span', { className: 'text-amber-700 dark:text-amber-400 font-medium' }, `ðŸ’¬ ${comments}`),
                                  h('span', { className: 'text-zinc-400 dark:text-zinc-500' }, `u/${post.author}`)
                                )
                              )
                            )
                          ),
                          // Quick actions menu button
                          h('div', { className: 'absolute top-2 right-2 opacity-0 group-hover:opacity-100 transition-opacity' },
                            h('button', {
                              onClick: (e) => { e.stopPropagation(); setActivePostMenu(activePostMenu === post.id ? null : post.id); },
                              className: 'p-2 rounded-lg bg-white dark:bg-zinc-700 shadow-sm border border-zinc-200 dark:border-zinc-600 text-zinc-600 dark:text-zinc-400 hover:bg-zinc-50 dark:hover:bg-zinc-600 transition-colors'
                            }, h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                              h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M12 5v.01M12 12v.01M12 19v.01M12 6a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2zm0 7a1 1 0 110-2 1 1 0 010 2z' })
                            )),
                            // Dropdown menu
                            activePostMenu === post.id && h('div', { 
                              className: 'absolute right-0 mt-1 w-40 bg-white dark:bg-zinc-800 rounded-lg shadow-lg border border-zinc-200 dark:border-zinc-700 py-1 z-20 animate-fadeIn',
                              onClick: (e) => e.stopPropagation()
                            },
                              h('button', {
                                onClick: () => { window.open(post.reddit_url || post.external_url, '_blank'); setActivePostMenu(null); },
                                className: 'w-full px-3 py-2 text-left text-sm text-zinc-700 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 flex items-center gap-2'
                              }, 
                                h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14' })
                                ),
                                'Open in Reddit'
                              ),
                              h('button', {
                                onClick: () => handleCopyLink(post),
                                className: 'w-full px-3 py-2 text-left text-sm text-zinc-700 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 flex items-center gap-2'
                              },
                                h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3' })
                                ),
                                'Copy link'
                              ),
                              h('button', {
                                onClick: () => handleHidePost(post.id),
                                className: 'w-full px-3 py-2 text-left text-sm text-zinc-700 dark:text-zinc-300 hover:bg-zinc-100 dark:hover:bg-zinc-700 flex items-center gap-2'
                              },
                                h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13.875 18.825A10.05 10.05 0 0112 19c-4.478 0-8.268-2.943-9.543-7a9.97 9.97 0 011.563-3.029m5.858.908a3 3 0 114.243 4.243M9.878 9.878l4.242 4.242M9.88 9.88l-3.29-3.29m7.532 7.532l3.29 3.29M3 3l3.59 3.59m0 0A9.953 9.953 0 0112 5c4.478 0 8.268 2.943 9.543 7a10.025 10.025 0 01-4.132 5.411m0 0L21 21' })
                                ),
                                'Hide post'
                              )
                            )
                          )
                        );
                      })
                    ),
              // Hover preview tooltip
              hoverPost && h('div', { 
                className: 'fixed z-50 max-w-sm bg-white dark:bg-zinc-800 rounded-xl shadow-xl border border-zinc-200 dark:border-zinc-700 p-4 pointer-events-none animate-fadeIn',
                style: { top: '50%', right: '420px', transform: 'translateY(-50%)' }
              },
                hoverPost.preview?.images?.[0]?.source?.url && h('img', {
                  src: hoverPost.preview.images[0].source.url.replace(/&amp;/g, '&'),
                  alt: '',
                  className: 'w-full h-40 object-cover rounded-lg mb-3 bg-zinc-200 dark:bg-zinc-700'
                }),
                h('p', { className: 'text-sm text-zinc-700 dark:text-zinc-300 line-clamp-4' }, 
                  hoverPost.selftext ? hoverPost.selftext.substring(0, 200) + (hoverPost.selftext.length > 200 ? '...' : '') : 'Link post â€” no preview available'
                )
              )
            )
          ),

          // Right - Post detail
          !detailCollapsed && h('aside', { className: `w-96 bg-white dark:bg-zinc-800 flex-col shrink-0 ${mobileView === 'detail' ? 'flex' : 'hidden lg:flex'}` },
            h('div', { className: 'p-3 border-b border-zinc-200 dark:border-zinc-700 flex items-center justify-between' },
              h('div', { className: 'flex items-center gap-2' },
                h('button', {
                  onClick: () => setMobileView('posts'),
                  className: 'lg:hidden p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-700 text-zinc-600 dark:text-zinc-400 transition-colors',
                  title: 'Back to posts'
                }, h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 19l-7-7 7-7' })
                )),
                h('span', { className: 'text-xs font-semibold uppercase tracking-wide text-zinc-500 dark:text-zinc-400' }, 'Post Detail')
              ),
              h('button', {
                onClick: () => setDetailCollapsed(true),
                className: 'hidden lg:block p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-700 text-zinc-600 dark:text-zinc-400 transition-colors',
                title: 'Collapse'
              }, h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M13 5l7 7-7 7M5 5l7 7-7 7' })
              ))
            ),
            h('div', { className: 'flex-1 overflow-auto scrollbar-thin p-4' },
            !selectedPost
                ? h('div', { className: 'flex flex-col items-center justify-center h-full' },
                    h('div', { className: 'w-16 h-16 mb-4 rounded-full bg-zinc-100 dark:bg-zinc-800 flex items-center justify-center' },
                      h('svg', { className: 'w-8 h-8 text-zinc-400', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M15 12a3 3 0 11-6 0 3 3 0 016 0z' }),
                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z' })
                      )
                    ),
                    h('p', { className: 'text-zinc-400 dark:text-zinc-500 text-sm' }, 'Select a post to view')
                  )
                : h('article', { className: 'space-y-4' },
                    h('div', { className: 'flex items-center gap-2 text-xs text-zinc-500 dark:text-zinc-400 flex-wrap' },
                      h('span', { className: 'px-2.5 py-1 rounded-full bg-zinc-100 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 font-medium text-xs' }, `r/${selectedPost.subreddit}`),
                      selectedPost.link_flair_text && h('span', { 
                        className: 'px-1.5 py-0.5 rounded-full text-[10px] font-medium',
                        style: { backgroundColor: selectedPost.link_flair_background_color || '#e4e4e7', color: selectedPost.link_flair_text_color === 'light' ? '#fff' : '#18181b' }
                      }, selectedPost.link_flair_text),
                      h('span', null, timeAgo(selectedPost.created_utc))
                    ),
                    h('h2', { className: 'text-lg font-bold text-zinc-900 dark:text-white leading-snug' }, selectedPost.title),
                    (() => {
                      const detailRelevanceScore = postRelevanceScores.get(String(selectedPost.id));
                      const detailRelevanceMeta = postRelevanceMetadata.get(String(selectedPost.id));
                      if (detailRelevanceScore !== undefined && detailRelevanceScore !== null) {
                        return h('div', { 
                          className: 'flex items-center gap-2 py-1',
                          title: detailRelevanceMeta ? `${detailRelevanceMeta.confidence} confidence â€¢ ${detailRelevanceMeta.reason}` : `AI Relevance: ${detailRelevanceScore}/10`
                        },
                          h('span', {
                            className: `px-2 py-0.5 rounded text-xs font-bold shadow-sm ${
                              detailRelevanceScore >= 8 ? 'bg-emerald-600 text-white ring-2 ring-emerald-300 dark:ring-emerald-400/30' :
                              detailRelevanceScore >= 7 ? 'bg-emerald-100 dark:bg-emerald-900/60 text-emerald-700 dark:text-emerald-200' :
                              detailRelevanceScore >= 5 ? 'bg-amber-100 dark:bg-amber-900/40 text-amber-700 dark:text-amber-200' :
                              'bg-zinc-200 dark:bg-zinc-700 text-zinc-600 dark:text-zinc-400'
                            }`
                          }, `AI ${detailRelevanceScore}/10`),
                          h('div', { 
                            className: 'w-16 h-1.5 bg-zinc-200 dark:bg-zinc-700 rounded-full overflow-hidden'
                          },
                            h('div', { 
                              className: `h-full rounded-full transition-all ${
                                detailRelevanceScore >= 8 ? 'bg-emerald-600' :
                                detailRelevanceScore >= 7 ? 'bg-emerald-500 dark:bg-emerald-400' :
                                detailRelevanceScore >= 5 ? 'bg-amber-500 dark:bg-amber-400' :
                                'bg-zinc-400 dark:bg-zinc-500'
                              }`,
                              style: { width: `${Math.min(100, Math.max(0, (detailRelevanceScore / 10) * 100))}%` }
                            })
                          ),
                          detailRelevanceMeta?.reason && h('span', { 
                            className: 'text-xs text-zinc-600 dark:text-zinc-400 line-clamp-1'
                          }, detailRelevanceMeta.reason)
                        );
                      }
                      return null;
                    })(),
                    h('div', { className: 'flex items-center gap-3 text-sm' },
                      h('span', { className: 'text-emerald-700 dark:text-emerald-400 font-medium' }, `â–² ${selectedPost.score}`),
                      h('span', { className: 'text-amber-700 dark:text-amber-400 font-medium' }, `ðŸ’¬ ${selectedPost.num_comments}`),
                      h('span', { className: 'text-zinc-500 dark:text-zinc-400' }, `u/${selectedPost.author}`)
                    ),
                    h('a', {
                      href: selectedPost.reddit_url || selectedPost.external_url,
                      target: '_blank',
                      rel: 'noreferrer',
                      className: 'inline-flex items-center gap-2 px-4 py-2 rounded-lg bg-zinc-900 dark:bg-indigo-600 text-white text-sm font-medium hover:bg-zinc-800 dark:hover:bg-indigo-700 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900'
                    },
                      'Open on Reddit',
                      h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14' })
                      )
                    ),
                    h('div', { className: 'border-t border-zinc-200 dark:border-zinc-700 pt-4' },
                      renderBody(selectedPost)
                  )
                )
          )
        ),

          // Collapsed detail toggle
          detailCollapsed && h('button', {
            onClick: () => setDetailCollapsed(false),
            className: 'hidden lg:flex items-center justify-center w-8 bg-white dark:bg-zinc-800 border-l border-zinc-200 dark:border-zinc-700 text-zinc-400 hover:text-zinc-600 dark:hover:text-zinc-300 hover:bg-zinc-50 dark:hover:bg-zinc-700 transition-colors',
            title: 'Expand detail panel'
          }, h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
            h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M11 19l-7-7 7-7m8 14l-7-7 7-7' })
          ))
        ),

        // Mobile bottom navigation
        h('nav', { className: 'lg:hidden fixed bottom-0 left-0 right-0 bg-white dark:bg-zinc-800 border-t border-zinc-200 dark:border-zinc-700 px-4 py-2 flex items-center justify-around z-40' },
          h('button', {
            onClick: () => setMobileView('subs'),
            className: `flex flex-col items-center gap-1 px-4 py-1 rounded-lg transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900 ${mobileView === 'subs' ? 'text-indigo-600 dark:text-indigo-400' : 'text-zinc-500 dark:text-zinc-400'}`
          },
            h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
              h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10' })
            ),
            h('span', { className: 'text-xs font-medium' }, 'Subs')
          ),
          h('button', {
            onClick: () => setMobileView('posts'),
            className: `flex flex-col items-center gap-1 px-4 py-1 rounded-lg transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900 ${mobileView === 'posts' ? 'text-indigo-600 dark:text-indigo-400' : 'text-zinc-500 dark:text-zinc-400'}`
          },
            h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
              h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M4 6h16M4 10h16M4 14h16M4 18h16' })
            ),
            h('span', { className: 'text-xs font-medium' }, 'Posts')
          ),
          h('button', {
            onClick: () => setMobileView('detail'),
            className: `flex flex-col items-center gap-1 px-4 py-1 rounded-lg transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900 ${mobileView === 'detail' ? 'text-indigo-600 dark:text-indigo-400' : 'text-zinc-500 dark:text-zinc-400'}`
          },
            h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
              h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z' })
            ),
            h('span', { className: 'text-xs font-medium' }, 'Detail')
          )
        ),

        // Add subreddit modal
        addSubOpen && h('div', { className: 'fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4', onClick: () => setAddSubOpen(false) },
          h('div', {
            className: 'w-full max-w-md bg-white dark:bg-zinc-800 rounded-xl shadow-xl',
            onClick: (e) => e.stopPropagation()
          },
            h('div', { className: 'p-4 border-b border-zinc-200 dark:border-zinc-700 flex items-center justify-between' },
              h('h3', { className: 'font-semibold text-zinc-900 dark:text-white' }, 'Add Subreddits'),
                h('button', {
                  onClick: () => setAddSubOpen(false),
                  className: 'p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-700 text-zinc-600 dark:text-zinc-400 transition-colors'
                }, h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                  h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
              ))
            ),
            h('div', { className: 'p-4 space-y-4' },
              h('div', null,
                h('label', { className: 'block text-sm font-medium text-zinc-700 dark:text-zinc-300 mb-1.5' }, 'Subreddit names'),
                h('textarea', {
                  ref: addSubInputRef,
                  value: addSubInput,
                  onChange: (e) => setAddSubInput(e.target.value),
                  placeholder: 'programming, webdev, javascript...',
                  className: 'w-full px-3 py-2 border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-zinc-900 focus:border-transparent',
                  rows: 3
                }),
                h('p', { className: 'mt-1 text-xs text-zinc-500 dark:text-zinc-400' }, 'Separate with commas or new lines')
              ),
              h('div', null,
                h('p', { className: 'text-xs font-medium text-zinc-500 dark:text-zinc-400 uppercase tracking-wide mb-2' }, 'Popular'),
                h('div', { className: 'flex flex-wrap gap-1.5' },
                  POPULAR_SUBREDDITS.slice(0, 10).map(sub =>
                    h('button', {
                      key: sub,
                      onClick: () => { handleAddSub(sub); setAddSubOpen(false); },
                      disabled: subs.some(s => s.toLowerCase() === sub.toLowerCase()),
                      className: 'px-2.5 py-1 rounded-full text-xs font-medium bg-zinc-100 dark:bg-zinc-700 text-zinc-700 dark:text-zinc-300 hover:bg-zinc-200 dark:hover:bg-zinc-600 disabled:opacity-40 disabled:cursor-not-allowed transition-colors'
                    }, sub)
                  )
                )
              )
            ),
            h('div', { className: 'p-4 border-t border-zinc-200 dark:border-zinc-700 flex justify-end gap-2' },
              h('button', {
                onClick: () => setAddSubOpen(false),
                className: 'px-4 py-2 rounded-lg text-sm font-medium text-zinc-600 dark:text-zinc-400 hover:bg-zinc-100 dark:hover:bg-zinc-700 transition-colors'
              }, 'Cancel'),
              h('button', {
                onClick: handleAddSubSubmit,
                disabled: !addSubInput.trim(),
                className: 'px-4 py-2 rounded-lg text-sm font-medium bg-zinc-900 dark:bg-indigo-600 text-white hover:bg-zinc-800 dark:hover:bg-indigo-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900'
              }, 'Add')
            )
          )
        ),

        // Settings modal
        settingsOpen && h('div', { className: 'fixed inset-0 z-50 flex items-center justify-center bg-black/40 p-4', onClick: () => setSettingsOpen(false) },
          h('div', {
            className: 'w-full max-w-lg bg-white dark:bg-zinc-800 rounded-xl shadow-xl max-h-[90vh] overflow-auto',
            onClick: (e) => e.stopPropagation()
          },
            h('div', { className: 'p-4 border-b border-zinc-200 dark:border-zinc-700 flex items-center justify-between sticky top-0 bg-white dark:bg-zinc-800' },
              h('h3', { className: 'font-semibold text-zinc-900 dark:text-white' }, 'Settings'),
                h('button', {
                onClick: () => setSettingsOpen(false),
                className: 'p-2 rounded-lg hover:bg-zinc-100 dark:hover:bg-zinc-700 text-zinc-600 dark:text-zinc-400 transition-colors'
              }, h('svg', { className: 'w-5 h-5', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M6 18L18 6M6 6l12 12' })
              ))
            ),
            h('div', { className: 'p-4 space-y-5' },
              h('div', { className: 'flex items-center justify-between' },
                h('div', null,
                  h('p', { className: 'font-medium text-zinc-900 dark:text-white' }, 'Auto-refresh'),
                  h('p', { className: 'text-sm text-zinc-500 dark:text-zinc-400' }, 'Automatically fetch new posts')
                ),
                h('div', { className: 'flex items-center gap-3' },
                  h('select', {
                    value: autoRefreshInterval,
                    onChange: (e) => setAutoRefreshInterval(Number(e.target.value)),
                    disabled: !autoRefreshEnabled,
                    className: 'px-2 py-1.5 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm disabled:opacity-50 disabled:cursor-not-allowed'
                  },
                    AUTO_REFRESH_OPTIONS.map(opt => h('option', { key: opt, value: opt }, `${opt} min`))
                  ),
                  h('button', {
                    onClick: () => setAutoRefreshEnabled(!autoRefreshEnabled),
                    className: `relative w-11 h-6 rounded-full transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900 ${autoRefreshEnabled ? 'bg-indigo-600' : 'bg-zinc-300 dark:bg-zinc-600'}`
                  },
                    h('span', { className: `absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${autoRefreshEnabled ? 'translate-x-5' : ''}` })
                  )
                )
              ),
              h('div', { className: 'grid grid-cols-2 gap-4' },
                h('label', { className: 'block' },
                  h('span', { className: 'text-sm font-medium text-zinc-700 dark:text-zinc-300' }, 'Listing mode'),
                    h('select', {
                      value: mode,
                    onChange: (e) => setMode(e.target.value),
                    className: 'mt-1 w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm'
                    },
                      h('option', { value: 'new' }, 'New'),
                      h('option', { value: 'top' }, 'Top')
                    )
                  ),
                h('label', { className: 'block' },
                  h('span', { className: 'text-sm font-medium text-zinc-700 dark:text-zinc-300' }, 'Top range'),
                    h('select', {
                      value: time,
                    onChange: (e) => setTime(e.target.value),
                      disabled: mode !== 'top',
                    className: 'mt-1 w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm disabled:opacity-50 disabled:cursor-not-allowed'
                    },
                      h('option', { value: 'hour' }, 'Hour'),
                      h('option', { value: 'day' }, 'Day'),
                      h('option', { value: 'week' }, 'Week'),
                      h('option', { value: 'month' }, 'Month')
                    )
                  ),
                h('label', { className: 'block' },
                  h('span', { className: 'text-sm font-medium text-zinc-700 dark:text-zinc-300' }, 'Lookback window'),
                    h('select', {
                      value: days,
                    onChange: (e) => setDays(Number(e.target.value)),
                    className: 'mt-1 w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm'
                    },
                    h('option', { value: 1 }, 'Day'),
                      h('option', { value: 3 }, '3 Days'),
                    h('option', { value: 7 }, 'Week')
                    )
                  ),
                h('label', { className: 'block' },
                  h('span', { className: 'text-sm font-medium text-zinc-700 dark:text-zinc-300' }, 'Max pages'),
                    h('select', {
                      value: maxPages,
                    onChange: (e) => setMaxPages(Number(e.target.value)),
                    className: 'mt-1 w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm'
                    },
                      [1, 2, 3, 5, 7, 10].map(n => h('option', { key: n, value: n }, n))
                  )
                )
              ),
              // Notifications section
              h('div', { className: 'pt-4 border-t border-zinc-200 dark:border-zinc-700' },
                h('p', { className: 'text-xs font-medium text-zinc-500 dark:text-zinc-400 uppercase tracking-wide mb-3' }, 'Notifications'),
                h('div', { className: 'space-y-4' },
                  h('div', { className: 'flex items-center justify-between' },
                    h('div', null,
                      h('p', { className: 'font-medium text-zinc-900 dark:text-white' }, 'Enable alerts'),
                      h('p', { className: 'text-sm text-zinc-500 dark:text-zinc-400' }, 'Get notified on auto-refresh')
                    ),
                    h('div', { className: 'flex items-center gap-2' },
                      Notification.permission !== 'granted' && h('button', {
                        onClick: requestNotificationPermission,
                        className: 'px-2.5 py-1 text-xs font-medium rounded-full bg-indigo-50 text-indigo-700 dark:bg-indigo-900/30 dark:text-indigo-300 hover:bg-indigo-100 dark:hover:bg-indigo-900/40 transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900'
                      }, 'Allow'),
                      h('button', {
                        onClick: () => setNotificationsEnabled(!notificationsEnabled),
                        disabled: Notification.permission !== 'granted',
                        className: `relative w-11 h-6 rounded-full transition-colors disabled:opacity-50 disabled:cursor-not-allowed focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900 ${notificationsEnabled ? 'bg-indigo-600' : 'bg-zinc-300 dark:bg-zinc-600'}`
                      },
                        h('span', { className: `absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${notificationsEnabled ? 'translate-x-5' : ''}` })
                      )
                    )
                  ),
                  h('label', { className: 'block' },
                    h('span', { className: 'text-sm font-medium text-zinc-700 dark:text-zinc-300' }, 'Upvote threshold'),
                    h('p', { className: 'text-xs text-zinc-500 dark:text-zinc-400 mb-1' }, 'Alert when a post crosses this score'),
                    h('input', {
                      type: 'number',
                      value: upvoteThreshold,
                      onChange: (e) => setUpvoteThreshold(Number(e.target.value) || 100),
                      disabled: !notificationsEnabled,
                      className: 'w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm disabled:opacity-50 disabled:cursor-not-allowed'
                    })
                  ),
                  h('label', { className: 'block' },
                    h('span', { className: 'text-sm font-medium text-zinc-700 dark:text-zinc-300' }, 'Alert keywords'),
                    h('p', { className: 'text-xs text-zinc-500 dark:text-zinc-400 mb-1' }, 'Notify when new posts contain these (comma-separated)'),
                    h('input', {
                      type: 'text',
                      value: alertKeywords,
                      onChange: (e) => setAlertKeywords(e.target.value),
                      placeholder: 'breaking, launch, announcement...',
                      disabled: !notificationsEnabled,
                      className: 'w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm disabled:opacity-50 disabled:cursor-not-allowed'
                    })
                  )
                )
              ),
              // AI Relevance Ranking section
              h('div', { className: 'pt-4 border-t border-zinc-200 dark:border-zinc-700' },
                h('p', { className: 'text-xs font-medium text-zinc-500 dark:text-zinc-400 uppercase tracking-wide mb-3' }, 'AI Relevance Ranking'),
                h('div', { className: 'space-y-4' },
                  h('div', { className: 'flex items-center justify-between' },
                    h('div', null,
                      h('p', { className: 'font-medium text-zinc-900 dark:text-white' }, 'Enable AI ranking'),
                      h('p', { className: 'text-sm text-zinc-500 dark:text-zinc-400' }, 'Rank posts by relevance to your goals')
                    ),
                    h('button', {
                      onClick: () => setAiEnabled(!aiEnabled),
                      className: `relative w-11 h-6 rounded-full transition-colors focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900 ${aiEnabled ? 'bg-indigo-600' : 'bg-zinc-300 dark:bg-zinc-600'}`
                    },
                      h('span', { className: `absolute top-0.5 left-0.5 w-5 h-5 bg-white rounded-full shadow transition-transform ${aiEnabled ? 'translate-x-5' : ''}` })
                    )
                  ),
                  h('label', { className: 'block' },
                    h('span', { className: 'text-sm font-medium text-zinc-700 dark:text-zinc-300' }, 'Your goals / context'),
                    h('p', { className: 'text-xs text-zinc-500 dark:text-zinc-400 mb-1' }, 'Describe what you\'re looking for (e.g., "I run an SEO agency and am looking for leads")'),
                    h('textarea', {
                      value: aiGoals,
                      onChange: (e) => setAiGoals(e.target.value),
                      placeholder: 'e.g., I run an SEO agency and am looking for leads',
                      disabled: !aiEnabled,
                      rows: 3,
                      className: 'w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-zinc-900 focus:border-transparent'
                    })
                  ),
                  h('div', { className: 'block' },
                    h('span', { className: 'text-sm font-medium text-zinc-700 dark:text-zinc-300' }, 'OpenRouter API Key'),
                    h('p', { className: 'text-xs text-zinc-500 dark:text-zinc-400 mb-1' }, 'Optional: Your own OpenRouter API key (get one at ', h('a', { href: 'https://openrouter.ai/keys', target: '_blank', className: 'text-indigo-600 dark:text-indigo-400 hover:underline' }, 'openrouter.ai/keys'), ')'),
                    // Show secure key status
                    secureKeyStatus.hasKey && h('div', { className: 'flex items-center gap-2 mb-2 p-2 bg-emerald-50 dark:bg-emerald-900/20 rounded-lg border border-emerald-200 dark:border-emerald-800' },
                      h('svg', { className: 'w-4 h-4 text-emerald-600 dark:text-emerald-400 shrink-0', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.618 3.04A12.02 12.02 0 003 9c0 5.591 3.824 10.29 9 11.622 5.176-1.332 9-6.03 9-11.622 0-1.042-.133-2.052-.382-3.016z' })
                      ),
                      h('div', { className: 'flex-1 min-w-0' },
                        h('p', { className: 'text-xs font-medium text-emerald-700 dark:text-emerald-300' }, 'Secure key stored'),
                        h('p', { className: 'text-xs text-emerald-600 dark:text-emerald-400 font-mono truncate' }, secureKeyStatus.keyPreview)
                      ),
                      h('button', {
                        onClick: deleteSecureApiKey,
                        className: 'p-1 text-emerald-600 dark:text-emerald-400 hover:text-rose-600 dark:hover:text-rose-400 transition-colors',
                        title: 'Remove secure key'
                      }, h('svg', { className: 'w-4 h-4', fill: 'none', stroke: 'currentColor', viewBox: '0 0 24 24' },
                        h('path', { strokeLinecap: 'round', strokeLinejoin: 'round', strokeWidth: 2, d: 'M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16' })
                      ))
                    ),
                    // Input for new key (only show if no secure key or user wants to update)
                    !secureKeyStatus.hasKey && h('div', { className: 'flex gap-2' },
                      h('input', {
                        type: 'password',
                        value: openRouterApiKey,
                        onChange: (e) => setOpenRouterApiKey(e.target.value),
                        placeholder: 'sk-or-v1-...',
                        disabled: !aiEnabled,
                        className: 'flex-1 px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-zinc-900 focus:border-transparent font-mono'
                      }),
                      openRouterApiKey.trim() && h('button', {
                        onClick: saveSecureApiKey,
                        disabled: savingSecureKey || !aiEnabled,
                        className: 'px-3 py-2 rounded-lg text-sm font-medium bg-emerald-600 text-white hover:bg-emerald-700 disabled:opacity-50 disabled:cursor-not-allowed transition-colors whitespace-nowrap',
                        title: 'Save key securely (HttpOnly cookie - XSS-safe)'
                      }, savingSecureKey ? 'Saving...' : 'Save securely')
                    ),
                    // Security note
                    !secureKeyStatus.hasKey && openRouterApiKey.trim() && h('p', { className: 'mt-1 text-xs text-amber-600 dark:text-amber-400' },
                      'âš ï¸ Click "Save securely" to protect your key from XSS attacks'
                    )
                  ),
                  h('label', { className: 'block' },
                    h('span', { className: 'text-sm font-medium text-zinc-700 dark:text-zinc-300' }, 'AI Model'),
                    h('p', { className: 'text-xs text-zinc-500 dark:text-zinc-400 mb-1' }, 'Choose the AI model for ranking posts'),
                    h('select', {
                      value: openRouterModel,
                      onChange: (e) => setOpenRouterModel(e.target.value),
                      disabled: !aiEnabled,
                      className: 'w-full px-3 py-2 rounded-lg border border-zinc-200 dark:border-zinc-600 dark:bg-zinc-700 dark:text-white text-sm disabled:opacity-50 disabled:cursor-not-allowed focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 focus:ring-offset-white dark:focus:ring-offset-zinc-900 focus:border-transparent'
                    },
                      h('optgroup', { label: 'Free Models (Latest)' },
                        h('option', { value: 'xiaomi/mimo-v2-flash:free' }, 'Xiaomi MiMo-V2-Flash (Free)'),
                        h('option', { value: 'mistralai/devstral-2512:free' }, 'Mistral Devstral 2 2512 (Free)'),
                        h('option', { value: 'tngtech/deepseek-r1t2-chimera:free' }, 'TNG DeepSeek R1T2 Chimera (Free)'),
                        h('option', { value: 'z-ai/glm-4.5-air:free' }, 'Z.AI GLM 4.5 Air (Free)'),
                        h('option', { value: 'deepseek/deepseek-r1-0528:free' }, 'DeepSeek R1 0528 (Free)'),
                        h('option', { value: 'qwen/qwen3-coder:free' }, 'Qwen3 Coder 480B A35B (Free)'),
                        h('option', { value: 'qwen/qwen3-next-80b-a3b-instruct:free' }, 'Qwen3 Next 80B A3B (Free)'),
                        h('option', { value: 'meta-llama/llama-3.3-70b-instruct:free' }, 'Meta Llama 3.3 70B (Free)'),
                        h('option', { value: 'google/gemma-3-27b-it:free' }, 'Google Gemma 3 27B (Free)'),
                        h('option', { value: 'nvidia/nemotron-3-nano-30b-a3b:free' }, 'NVIDIA Nemotron 3 Nano 30B (Free)'),
                        h('option', { value: 'openai/gpt-oss-120b:free' }, 'OpenAI gpt-oss-120b (Free)'),
                        h('option', { value: 'openai/gpt-oss-20b:free' }, 'OpenAI gpt-oss-20b (Free)'),
                        h('option', { value: 'arcee-ai/trinity-mini:free' }, 'Arcee AI Trinity Mini (Free)')
                      ),
                      h('optgroup', { label: 'Paid Models (Popular)' },
                        h('option', { value: 'anthropic/claude-sonnet-4.5' }, 'Claude Sonnet 4.5'),
                        h('option', { value: 'openai/gpt-4o' }, 'GPT-4o'),
                        h('option', { value: 'openai/gpt-4o-mini' }, 'GPT-4o Mini'),
                        h('option', { value: 'google/gemini-pro-1.5' }, 'Gemini Pro 1.5')
                      )
                    )
                  ),
                  aiRankingLoading && h('div', { className: 'flex items-center gap-2 text-sm text-zinc-600 dark:text-zinc-400' },
                    h('div', { className: 'w-3 h-3 border-2 border-zinc-300 dark:border-zinc-600 border-t-zinc-600 dark:border-t-zinc-300 rounded-full animate-spin' }),
                    'Analyzing posts...'
                  )
                )
              ),
              h('div', { className: 'pt-4 border-t border-zinc-200 dark:border-zinc-700' },
                h('p', { className: 'text-xs font-medium text-zinc-500 dark:text-zinc-400 uppercase tracking-wide mb-3' }, 'Data Management'),
                h('div', { className: 'flex gap-2' },
                  h('button', {
                    onClick: () => {
                      const backup = JSON.stringify({ subs, maxPages, autoRefreshEnabled, autoRefreshInterval, notificationsEnabled, upvoteThreshold, alertKeywords, aiGoals, aiEnabled, openRouterApiKey, openRouterModel });
                      navigator.clipboard.writeText(backup);
                      alert('Settings copied to clipboard');
                    },
                    className: 'px-4 py-2 rounded-lg text-sm font-medium text-zinc-600 hover:bg-zinc-100 dark:text-zinc-400 dark:hover:bg-zinc-700 transition-colors'
                  }, 'Export settings'),
                  h('button', {
                    onClick: () => {
                      const input = prompt('Paste your settings backup:');
                      if (input) {
                        try {
                          const parsed = JSON.parse(input);
                          if (parsed.subs) setSubs(parsed.subs);
                          if (parsed.maxPages) setMaxPages(parsed.maxPages);
                          if (typeof parsed.autoRefreshEnabled === 'boolean') setAutoRefreshEnabled(parsed.autoRefreshEnabled);
                          if (parsed.autoRefreshInterval) setAutoRefreshInterval(parsed.autoRefreshInterval);
                          if (typeof parsed.notificationsEnabled === 'boolean') setNotificationsEnabled(parsed.notificationsEnabled);
                          if (parsed.upvoteThreshold) setUpvoteThreshold(parsed.upvoteThreshold);
                          if (parsed.alertKeywords !== undefined) setAlertKeywords(parsed.alertKeywords);
                          if (parsed.aiGoals !== undefined) setAiGoals(parsed.aiGoals);
                          if (typeof parsed.aiEnabled === 'boolean') setAiEnabled(parsed.aiEnabled);
                          if (parsed.openRouterApiKey !== undefined) setOpenRouterApiKey(parsed.openRouterApiKey);
                          if (parsed.openRouterModel !== undefined) setOpenRouterModel(parsed.openRouterModel);
                          alert('Settings restored');
                        } catch (e) {
                          alert('Invalid backup format');
                        }
                      }
                    },
                    className: 'px-4 py-2 rounded-lg text-sm font-medium text-zinc-600 hover:bg-zinc-100 dark:text-zinc-400 dark:hover:bg-zinc-700 transition-colors'
                  }, 'Import settings')
                )
              )
            ),
            h('div', { className: 'p-4 border-t border-zinc-200 dark:border-zinc-700 flex justify-end sticky bottom-0 bg-white dark:bg-zinc-800' },
                h('button', {
                onClick: () => setSettingsOpen(false),
                className: 'px-4 py-2 rounded-lg text-sm font-medium bg-zinc-900 dark:bg-indigo-600 text-white hover:bg-zinc-800 dark:hover:bg-indigo-700 transition-colors'
              }, 'Done')
            )
          )
        )
      );
    }

    // Utility functions
    
    // Heuristic scoring for two-stage ranking
    function extractGoalKeywords(goalsText) {
      if (!goalsText) return [];
      // Simple keyword extraction: split by common delimiters and filter short words
      const words = goalsText.toLowerCase()
        .split(/[\s,;.!?()]+/)
        .filter(w => w.length >= 3)
        .filter(w => !['the', 'and', 'for', 'that', 'this', 'with', 'from', 'are', 'was', 'have', 'has'].includes(w));
      // Remove duplicates and return top 20
      return [...new Set(words)].slice(0, 20);
    }
    
    function computeHeuristicScore(post, keywords) {
      if (!keywords || keywords.length === 0) return 0;
      
      const title = (post.title || '').toLowerCase();
      const selftext = (post.selftext || '').toLowerCase();
      const subreddit = (post.subreddit || '').toLowerCase();
      const domain = post.domain || '';
      
      let score = 0;
      
      // Title keyword matches (weighted heavily)
      keywords.forEach(kw => {
        if (title.includes(kw)) score += 3;
      });
      
      // Selftext keyword matches
      keywords.forEach(kw => {
        if (selftext.includes(kw)) score += 1;
      });
      
      // Subreddit match bonus
      keywords.forEach(kw => {
        if (subreddit.includes(kw)) score += 2;
      });
      
      // Domain-based signals
      if (domain && !domain.includes('reddit')) {
        // External link, slight bonus for being a resource
        score += 0.5;
      }
      
      // Engagement signals (normalized)
      const upvotes = Number(post.score) || 0;
      const comments = Number(post.num_comments) || 0;
      if (upvotes > 100) score += 1;
      if (upvotes > 500) score += 1;
      if (comments > 20) score += 1;
      if (comments > 50) score += 1;
      
      return score;
    }
    
    // Calibrate scores using percentile-based normalization
    // Ensures top ~10% get scores >= 7, and distribution is meaningful
    function calibrateScores(scoresMap) {
      if (!scoresMap || scoresMap.size === 0) return scoresMap;
      
      // Extract all valid scores
      const entries = Array.from(scoresMap.entries()).filter(([_, score]) => score !== null && score !== undefined);
      if (entries.length === 0) return scoresMap;
      
      // Edge case: single post should get a high score (assume relevant since it matched filters)
      if (entries.length === 1) {
        const calibrated = new Map();
        calibrated.set(entries[0][0], 8); // Give single posts a good default score
        scoresMap.forEach((score, postId) => {
          if (score === null || score === undefined) {
            calibrated.set(postId, score);
          }
        });
        return calibrated;
      }
      
      // Sort by score descending
      entries.sort((a, b) => b[1] - a[1]);
      
      // Map scores to 0-10 scale based on percentile
      const calibrated = new Map();
      entries.forEach(([postId, rawScore], index) => {
        // Percentile: 0.0 (worst) to 1.0 (best)
        const percentile = (entries.length - index - 1) / (entries.length - 1);
        // Map percentile to 0-10 scale with emphasis on top performers
        // Top 10% get 8-10, next 20% get 6-7, next 30% get 4-5, bottom 40% get 0-3
        let calibratedScore;
        if (percentile >= 0.9) {
          calibratedScore = 8 + Math.round((percentile - 0.9) / 0.1 * 2);
        } else if (percentile >= 0.7) {
          calibratedScore = 6 + Math.round((percentile - 0.7) / 0.2 * 1);
        } else if (percentile >= 0.4) {
          calibratedScore = 4 + Math.round((percentile - 0.4) / 0.3 * 1);
        } else {
          calibratedScore = Math.round(percentile / 0.4 * 3);
        }
        calibrated.set(postId, Math.max(0, Math.min(10, calibratedScore)));
      });
      
      // Preserve null scores
      scoresMap.forEach((score, postId) => {
        if (score === null || score === undefined) {
          calibrated.set(postId, score);
        }
      });
      
      return calibrated;
    }
    
    function formatTimeUntil(timestamp) {
      if (!timestamp) return '';
      const diff = Math.max(0, Number(timestamp) - Date.now());
      if (diff < 60 * 1000) return 'in <1 min';
      const minutes = Math.round(diff / 60000);
      if (minutes < 60) return `in ${minutes}m`;
      const hours = Math.floor(minutes / 60);
      return `in ${hours}h ${minutes % 60}m`;
    }

    function normalizeSubredditName(value) {
      if (typeof value !== 'string') return '';
      return value.trim().replace(/^r\//i, '').trim();
    }

    function timeAgo(utcSeconds) {
      const now = Date.now() / 1000;
      const diff = Math.max(1, Math.floor(now - (utcSeconds || 0)));
      const units = [
        [31536000, 'y'], [2592000, 'mo'], [604800, 'w'],
        [86400, 'd'], [3600, 'h'], [60, 'm'], [1, 's'],
      ];
      for (const [seconds, name] of units) {
        if (diff >= seconds) return `${Math.floor(diff / seconds)}${name}`;
      }
      return 'now';
    }

    function formatSubs(value) {
      if (!value && value !== 0) return '';
      if (value < 1000) return String(value);
      const units = ['k', 'M', 'B'];
      let unitIndex = -1;
      let val = value;
      while (val >= 1000 && unitIndex < units.length - 1) {
        val /= 1000;
        unitIndex += 1;
      }
      return `${val.toFixed(val >= 10 ? 0 : 1)}${units[unitIndex]}`;
    }

    function parseNumberFilter(value) {
      if (value === null || value === undefined || value === '') return null;
      const num = Number(value);
      return Number.isFinite(num) ? num : null;
    }

    function renderBody(post) {
      if (post.selftext_html) {
        const decoded = post.selftext_html
          .replace(/&lt;/g, '<').replace(/&gt;/g, '>')
          .replace(/&amp;/g, '&').replace(/&quot;/g, '"').replace(/&#39;/g, "'");
        const sanitized = DOMPurify.sanitize(decoded);
        return h('div', {
          className: 'post-body prose prose-sm prose-zinc dark:prose-invert max-w-none',
          dangerouslySetInnerHTML: { __html: sanitized },
        });
      }
      if (post.selftext) {
        return h('div', { className: 'post-body whitespace-pre-wrap text-zinc-700 dark:text-zinc-300 text-sm' }, post.selftext);
      }
      return h('div', { className: 'text-sm text-zinc-400 dark:text-zinc-500 italic' }, 'Link post â€” no text content');
    }

    // Login Page Component with Dashboard Preview
    function LoginPage({ onAuthSuccess, showPreview = true }) {
      const [isDark, setIsDark] = useState(() => {
        if (typeof window !== 'undefined') {
          const saved = localStorage.getItem('theme');
          if (saved) return saved === 'dark';
          return window.matchMedia('(prefers-color-scheme: dark)').matches;
        }
        return false;
      });

      useEffect(() => {
        if (isDark) {
          document.documentElement.classList.add('dark');
        } else {
          document.documentElement.classList.remove('dark');
        }
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      }, [isDark]);

      const handleLogin = () => {
        window.location.href = '/api/auth/start';
      };

      return h('div', { className: 'relative min-h-screen' },
        // Dashboard preview in background (blurred)
        showPreview && h('div', { className: 'dashboard-preview' },
          h(App)
        ),
        // Login overlay
        h('div', { className: 'login-overlay flex items-center justify-center p-4' },
          h('div', { className: 'w-full max-w-md animate-fadeIn' },
            // Glass card
            h('div', { className: 'glass rounded-xl p-8 text-center space-y-6' },
              // Logo/Icon area
              h('div', { className: 'flex justify-center' },
                h('div', { className: 'w-20 h-20 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center shadow-lg' },
                  h('svg', { className: 'w-10 h-10 text-white', fill: 'currentColor', viewBox: '0 0 24 24' },
                    h('path', { d: 'M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z' })
                  )
                )
              ),
              // Title
              h('div', null,
                h('h1', { className: 'text-3xl font-bold text-zinc-900 dark:text-zinc-100' }, 'Reddit Dashboard'),
                h('p', { className: 'mt-2 text-base text-zinc-600 dark:text-zinc-400' }, 'Browse your favorite subreddits with AI-powered insights')
              ),
              // Features list
              h('div', { className: 'space-y-2 text-left' },
                h('div', { className: 'flex items-center gap-2 text-sm text-zinc-700 dark:text-zinc-300' },
                  h('div', { className: 'w-1.5 h-1.5 rounded-full bg-indigo-600' }),
                  h('span', null, 'AI-powered post ranking')
                ),
                h('div', { className: 'flex items-center gap-2 text-sm text-zinc-700 dark:text-zinc-300' },
                  h('div', { className: 'w-1.5 h-1.5 rounded-full bg-indigo-600' }),
                  h('span', null, 'Multi-subreddit browsing')
                ),
                h('div', { className: 'flex items-center gap-2 text-sm text-zinc-700 dark:text-zinc-300' },
                  h('div', { className: 'w-1.5 h-1.5 rounded-full bg-indigo-600' }),
                  h('span', null, 'Advanced filtering & sorting')
                )
              ),
              // Login button
              h('button', {
                onClick: handleLogin,
                className: 'w-full inline-flex items-center justify-center gap-2 rounded-lg px-4 py-3 text-sm font-semibold leading-5 transition-all duration-150 bg-indigo-600 text-white hover:bg-indigo-700 hover:shadow-lg active:bg-indigo-800 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-indigo-500 focus-visible:ring-offset-2 focus-visible:ring-offset-white dark:focus-visible:ring-offset-zinc-900'
              },
                h('svg', { className: 'w-5 h-5', fill: 'currentColor', viewBox: '0 0 24 24' },
                  h('path', { d: 'M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z' })
                ),
                'Sign in with Reddit'
              ),
              // Divider
              h('div', { className: 'flex items-center gap-3' },
                h('div', { className: 'flex-1 border-t border-zinc-300 dark:border-zinc-600' }),
                h('div', { className: 'flex-1 border-t border-zinc-300 dark:border-zinc-600' })
              ),
              // Theme toggle
              h('button', {
                onClick: () => setIsDark(!isDark),
                className: 'text-sm text-zinc-600 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100 transition-colors inline-flex items-center gap-2'
              },
                h('span', null, isDark ? 'â˜€ï¸' : 'ðŸŒ™'),
                h('span', null, isDark ? 'Light Mode' : 'Dark Mode')
              )
            )
          )
        )
      );
    }

    // App with Auth wrapper
    function AppWithAuth() {
      const [authState, setAuthState] = useState({ loading: true, authenticated: false });

      useEffect(() => {
        // Check auth status on mount
        fetch('/api/auth/status')
          .then(res => res.json())
          .then(data => {
            setAuthState({ loading: false, authenticated: data.authenticated });
          })
          .catch(err => {
            console.error('Auth check failed:', err);
            setAuthState({ loading: false, authenticated: false });
          });
      }, []);

      if (authState.loading) {
        return h('div', { className: 'relative min-h-screen' },
          // Dashboard preview in background
          h('div', { className: 'dashboard-preview' },
            h(App)
          ),
          // Loading overlay
          h('div', { className: 'login-overlay flex items-center justify-center' },
            h('div', { className: 'glass rounded-xl p-8' },
              h('div', { className: 'text-center' },
                h('div', { className: 'w-16 h-16 bg-gradient-to-br from-indigo-600 to-purple-600 rounded-2xl flex items-center justify-center mx-auto mb-4 animate-pulse' },
                  h('svg', { className: 'w-8 h-8 text-white', fill: 'currentColor', viewBox: '0 0 24 24' },
                    h('path', { d: 'M12 0A12 12 0 0 0 0 12a12 12 0 0 0 12 12 12 12 0 0 0 12-12A12 12 0 0 0 12 0zm5.01 4.744c.688 0 1.25.561 1.25 1.249a1.25 1.25 0 0 1-2.498.056l-2.597-.547-.8 3.747c1.824.07 3.48.632 4.674 1.488.308-.309.73-.491 1.207-.491.968 0 1.754.786 1.754 1.754 0 .716-.435 1.333-1.01 1.614a3.111 3.111 0 0 1 .042.52c0 2.694-3.13 4.87-7.004 4.87-3.874 0-7.004-2.176-7.004-4.87 0-.183.015-.366.043-.534A1.748 1.748 0 0 1 4.028 12c0-.968.786-1.754 1.754-1.754.463 0 .898.196 1.207.49 1.207-.883 2.878-1.43 4.744-1.487l.885-4.182a.342.342 0 0 1 .14-.197.35.35 0 0 1 .238-.042l2.906.617a1.214 1.214 0 0 1 1.108-.701zM9.25 12C8.561 12 8 12.562 8 13.25c0 .687.561 1.248 1.25 1.248.687 0 1.248-.561 1.248-1.249 0-.688-.561-1.249-1.249-1.249zm5.5 0c-.687 0-1.248.561-1.248 1.25 0 .687.561 1.248 1.249 1.248.688 0 1.249-.561 1.249-1.249 0-.687-.562-1.249-1.25-1.249zm-5.466 3.99a.327.327 0 0 0-.231.094.33.33 0 0 0 0 .463c.842.842 2.484.913 2.961.913.477 0 2.105-.056 2.961-.913a.361.361 0 0 0 .029-.463.33.33 0 0 0-.464 0c-.547.533-1.684.73-2.512.73-.828 0-1.979-.196-2.512-.73a.326.326 0 0 0-.232-.095z' })
                  )
                ),
                h('p', { className: 'text-zinc-700 dark:text-zinc-300 font-medium' }, 'Loading...')
              )
            )
          )
        );
      }

      if (!authState.authenticated) {
        return h(LoginPage, { 
          onAuthSuccess: () => setAuthState({ loading: false, authenticated: true }),
          showPreview: true 
        });
      }

      return h(App);
    }

    const root = createRoot(document.getElementById('root'));
    root.render(h(AppWithAuth));
  </script>
</body>
</html>
